# Story 5.2: Manual Test Plan - Local Action Type

## Test Environment Setup

### Prerequisites
- Go 1.21+ installed
- Access to a Kubernetes cluster (minikube/kind/real cluster)
- kubectl configured with valid context
- Test namespace with running pods

### Test Data Preparation

Create test pods in your cluster:
```bash
kubectl create namespace test-kubertino
kubectl run test-pod-1 --image=nginx -n test-kubertino
kubectl run test-pod-2 --image=nginx -n test-kubertino
kubectl run worker-pod --image=nginx -n test-kubertino
```

---

## Test Case 1: Basic Local Command Execution

**AC Covered:** AC1, AC2, AC3

**Test Steps:**
1. Create test Go file:
```go
package main

import (
    "github.com/maratkarimov/kubertino/internal/config"
    "github.com/maratkarimov/kubertino/internal/executor"
    "github.com/maratkarimov/kubertino/internal/k8s"
)

func main() {
    action := config.Action{
        Name:       "Show Pod Info",
        Command:    "echo 'Context: {{.context}}, Namespace: {{.namespace}}, Pod: {{.pod}}'",
        PodPattern: "test-pod-.*",
    }

    context := config.Context{
        Name:              "minikube",
        DefaultPodPattern: ".*",
    }

    pods := []k8s.Pod{
        {Name: "test-pod-1", Status: "Running"},
        {Name: "test-pod-2", Status: "Running"},
    }

    exec := executor.NewExecutor(nil)
    err := exec.ExecuteLocal(action, context, "test-kubertino", pods, "")
    if err != nil {
        panic(err)
    }
}
```

2. Run the test

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Show Pod Info         │
│                                   │
╰───────────────────────────────────╯

Context: minikube, Namespace: test-kubertino, Pod: test-pod-1
```

**Success Criteria:**
- ✓ Context box displayed with bright cyan border
- ✓ All four fields shown (Context, Namespace, Pod, Action)
- ✓ Command output shows substituted variables
- ✓ Exit code 0 (no error)

---

## Test Case 2: Template Variable Substitution - All Variables

**AC Covered:** AC3

**Test Command:**
```go
Command: "kubectl get pod {{.pod}} -n {{.namespace}} --context {{.context}} -o name"
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Get Pod Name          │
│                                   │
╰───────────────────────────────────╯

pod/test-pod-1
```

**Success Criteria:**
- ✓ All three variables ({{.context}}, {{.namespace}}, {{.pod}}) correctly substituted
- ✓ kubectl command executes successfully
- ✓ Pod name returned

---

## Test Case 3: Complex Shell Command with Pipes

**AC Covered:** AC2, AC4

**Test Command:**
```go
Command: "kubectl logs {{.pod}} -n {{.namespace}} --tail=5 | grep -i error || echo 'No errors found'"
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Check Logs            │
│                                   │
╰───────────────────────────────────╯

No errors found
```

**Success Criteria:**
- ✓ Complex shell syntax (pipes, logical operators) works
- ✓ Command executed via sh -c
- ✓ Output displayed correctly
- ✓ No template parsing errors

---

## Test Case 4: Environment Variable Preservation

**AC Covered:** AC7

**Setup:**
```bash
export TEST_VAR="kubertino_test_value"
export CUSTOM_PATH="/custom/path"
```

**Test Command:**
```go
Command: "echo $TEST_VAR && echo $PATH | grep -o /custom/path"
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Check Environment     │
│                                   │
╰───────────────────────────────────╯

kubertino_test_value
/custom/path
```

**Success Criteria:**
- ✓ Parent shell environment variables accessible
- ✓ TEST_VAR value preserved
- ✓ PATH includes custom path
- ✓ All standard environment variables (HOME, USER, SHELL) available

---

## Test Case 5: KUBECONFIG Environment Variable

**AC Covered:** AC2

**Test Command:**
```go
kubeconfigPath := "/path/to/custom/kubeconfig"
Command: "echo $KUBECONFIG"
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Show Kubeconfig       │
│                                   │
╰───────────────────────────────────╯

/path/to/custom/kubeconfig
```

**Success Criteria:**
- ✓ KUBECONFIG environment variable set when kubeconfigPath provided
- ✓ Variable not set when kubeconfigPath is empty string

---

## Test Case 6: Pod Pattern Matching - Action Pattern

**AC Covered:** AC1, AC3

**Test Setup:**
```go
action := config.Action{
    Name:       "Worker Pod Command",
    Command:    "echo {{.pod}}",
    PodPattern: "worker-.*",  // Action-specific pattern
}

context := config.Context{
    Name:              "minikube",
    DefaultPodPattern: "test-pod-.*",  // Different default
}

pods := []k8s.Pod{
    {Name: "test-pod-1", Status: "Running"},
    {Name: "worker-pod", Status: "Running"},
}
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       worker-pod            │
│  Action:    Worker Pod Command    │
│                                   │
╰───────────────────────────────────╯

worker-pod
```

**Success Criteria:**
- ✓ Action pattern (worker-.*) used instead of context default (test-pod-.*)
- ✓ Correct pod (worker-pod) matched

---

## Test Case 7: Pod Pattern Matching - Context Default

**AC Covered:** AC1, AC3

**Test Setup:**
```go
action := config.Action{
    Name:       "Default Pattern",
    Command:    "echo {{.pod}}",
    PodPattern: "",  // Empty - use context default
}

context := config.Context{
    Name:              "minikube",
    DefaultPodPattern: "test-pod-1",  // Exact match
}

pods := []k8s.Pod{
    {Name: "test-pod-1", Status: "Running"},
    {Name: "test-pod-2", Status: "Running"},
}
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Default Pattern       │
│                                   │
╰───────────────────────────────────╯

test-pod-1
```

**Success Criteria:**
- ✓ Context default pattern used when action pattern empty
- ✓ Correct pod matched

---

## Test Case 8: Error - Invalid Template Syntax

**AC Covered:** AC6

**Test Setup:**
```go
action := config.Action{
    Name:       "Bad Template",
    Command:    "echo {{.namespace",  // Missing closing braces
    PodPattern: ".*",
}
```

**Expected Result:**

Error returned with message:
```
invalid command template: template: action:1: unclosed action
```

**Success Criteria:**
- ✓ Error caught during template parsing
- ✓ Clear error message indicating template syntax issue
- ✓ No command execution attempted
- ✓ Error wrapped with context

---

## Test Case 9: Error - No Pods Match Pattern

**AC Covered:** AC6

**Test Setup:**
```go
action := config.Action{
    Name:       "Missing Pod",
    Command:    "echo test",
    PodPattern: "nonexistent-.*",
}

pods := []k8s.Pod{
    {Name: "test-pod-1", Status: "Running"},
}
```

**Expected Result:**

Error returned with message:
```
no pods match pattern 'nonexistent-.*' - available pods: test-pod-1
```

**Success Criteria:**
- ✓ Error caught during pod matching
- ✓ Error message shows pattern that failed
- ✓ Error message lists available pods for debugging
- ✓ No command execution attempted

---

## Test Case 10: Error - Multiple Pods Match Pattern

**AC Covered:** AC6

**Test Setup:**
```go
action := config.Action{
    Name:       "Ambiguous Pattern",
    Command:    "echo test",
    PodPattern: "test-pod-.*",
}

pods := []k8s.Pod{
    {Name: "test-pod-1", Status: "Running"},
    {Name: "test-pod-2", Status: "Running"},
}
```

**Expected Result:**

Error returned with message:
```
multiple pods match pattern 'test-pod-.*': test-pod-1, test-pod-2
```

**Success Criteria:**
- ✓ Error caught during pod matching
- ✓ Error message shows pattern that matched multiple pods
- ✓ Error message lists all matching pods
- ✓ No command execution attempted (ambiguous which pod to use)

---

## Test Case 11: Error - Command Not Found

**AC Covered:** AC5, AC6

**Test Setup:**
```go
action := config.Action{
    Name:       "Invalid Command",
    Command:    "nonexistent-command-xyz",
    PodPattern: ".*",
}
```

**Expected Result:**

Error returned with message:
```
command execution failed: exit status 127
```

**Success Criteria:**
- ✓ Command execution attempted
- ✓ Exit code 127 captured (command not found)
- ✓ Error wrapped with "command execution failed" context
- ✓ Context box shown before error

---

## Test Case 12: Error - Command Execution Failure

**AC Covered:** AC5, AC6

**Test Setup:**
```go
action := config.Action{
    Name:       "Failing Command",
    Command:    "kubectl get pod nonexistent-pod-xyz -n {{.namespace}}",
    PodPattern: ".*",
}
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Failing Command       │
│                                   │
╰───────────────────────────────────╯

Error from server (NotFound): pods "nonexistent-pod-xyz" not found
```

Error returned:
```
command execution failed: exit status 1
```

**Success Criteria:**
- ✓ Context box displayed
- ✓ Command executed (kubectl error shown)
- ✓ Non-zero exit code captured
- ✓ Error returned with "command execution failed" wrapper

---

## Test Case 13: PrepareLocal - Command Ready for TUI

**AC Covered:** AC4

**Test Setup:**
```go
cmd, err := exec.PrepareLocal(action, context, namespace, pods, kubeconfigPath)
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Test Action           │
│                                   │
╰───────────────────────────────────╯

cmd != nil
cmd.Stdin == os.Stdin
cmd.Stdout == os.Stdout
cmd.Stderr == os.Stderr
cmd.Env contains all parent environment variables
```

**Success Criteria:**
- ✓ Context box rendered before returning
- ✓ *exec.Cmd returned (not nil)
- ✓ Command not executed yet (ready for tea.ExecProcess)
- ✓ Stdin/Stdout/Stderr set to os.Stdin/Stdout/Stderr
- ✓ Environment includes parent variables
- ✓ KUBECONFIG in environment if kubeconfigPath provided

---

## Test Case 14: Interactive Command Output

**AC Covered:** AC4

**Test Command:**
```go
Command: "kubectl exec -it {{.pod}} -n {{.namespace}} -- bash -c 'echo Hello from pod && pwd'"
```

**Expected Result:**

```
╭───────────────────────────────────╮
│                                   │
│  Context:   minikube              │
│  Namespace: test-kubertino        │
│  Pod:       test-pod-1            │
│  Action:    Interactive Shell     │
│                                   │
╰───────────────────────────────────╯

Hello from pod
/
```

**Success Criteria:**
- ✓ TUI minimized/hidden during execution
- ✓ Command output shown directly in terminal
- ✓ Interactive commands work (if using -it flag)
- ✓ Control returns to caller after command completes

---

## Summary of Expected Behaviors

### Context Box Display (All Test Cases)
- Bright cyan rounded border
- Four fields: Context, Namespace, Pod, Action
- Displayed before command execution
- Consistent formatting across all commands

### Template Substitution
- `{{.context}}` → context name (e.g., "minikube")
- `{{.namespace}}` → namespace name (e.g., "test-kubertino")
- `{{.pod}}` → matched pod name (e.g., "test-pod-1")

### Environment Handling
- Parent environment preserved (TEST_VAR, PATH, HOME, etc.)
- KUBECONFIG added when kubeconfigPath provided
- No environment variables lost during execution

### Error Messages
- Template errors: "invalid command template: {details}"
- Pod matching errors: "no pods match pattern '{pattern}' - available pods: {list}"
- Multiple matches: "multiple pods match pattern '{pattern}': {list}"
- Execution errors: "command execution failed: {error}"

### Exit Codes
- Success: return nil (exit code 0)
- Failure: return error with wrapped context

---

## Clean Up

After testing:
```bash
kubectl delete namespace test-kubertino
```
