# Story 7.4: Actions Panel Dynamic Column Layout

## Status

Draft

## Story

**As a** Kubertino user,
**I want** actions to display in the minimum number of columns needed based on available panel height,
**so that** the layout efficiently uses vertical space and avoids unnecessary horizontal spreading.

## Acceptance Criteria

1. **Dynamic Column Calculation Based on Height:**
   - Calculate available height for action items (panel height - borders - title - help text)
   - If all actions fit in available height → display in 1 column
   - If actions don't fit in 1 column → calculate minimum columns needed
   - Add columns only when necessary to fit all actions vertically

2. **Column Distribution:**
   - Actions flow vertically down each column (top to bottom)
   - Columns flow left to right
   - Each column contains approximately equal number of items
   - Formula: `columnsNeeded = ceil(totalActions / availableHeight)`

3. **Visual Layout:**
   - Consistent spacing between columns
   - Actions within column maintain vertical alignment
   - Maintain existing action format: `[shortcut] Action Name`
   - Actions panel remains non-focusable (Story 6.2 design)

4. **No Regression:**
   - All existing action functionality continues to work
   - Action shortcuts work globally from any panel
   - Panel borders and styling remain consistent

## Tasks / Subtasks

- [ ] Analyze current column calculation implementation (AC: 1, 2)
  - [ ] Read current `renderActionsPanel()` method in `internal/tui/app.go` (lines 1216-1277)
  - [ ] Understand current column calculation logic (lines 1228-1231: fixed 2 or 3 columns based on width)
  - [ ] Document current problem: columns based on width, not height
  - [ ] Review Lip Gloss JoinHorizontal/JoinVertical usage for layout composition
  - [ ] Document current dimensions: width, height, itemsPerColumn calculation

- [ ] Design height-based column calculation algorithm (AC: 1, 2)
  - [ ] Calculate available height for action items (height - border - padding - title - help text)
  - [ ] Reserve space for UI elements: title (1 line), blank (1 line), help text (2 lines), border (2 lines) = ~6 lines
  - [ ] Calculate available item height: `availableHeight = panelHeight - 6`
  - [ ] Calculate minimum columns needed: `columnsNeeded = ceil(totalActions / availableHeight)`
  - [ ] If `columnsNeeded == 0` or actions fit in height → use 1 column
  - [ ] Design fallback for edge cases (very short panels, many actions)

- [ ] Implement height-based column calculation (AC: 1, 2, 3)
  - [ ] Replace width-based column logic (lines 1228-1231) with height-based calculation
  - [ ] Calculate available height: `availableHeight = height - 8` (account for borders, title, help, padding)
  - [ ] Calculate columns needed: `columnCount = max(1, ceil(len(actions) / availableHeight))`
  - [ ] Keep existing items per column calculation: `itemsPerColumn = (len(actions) + columnCount - 1) / columnCount`
  - [ ] Keep existing column rendering logic (vertical flow per column, horizontal join of columns)
  - [ ] Maintain existing action format: `[shortcut] Action Name`
  - [ ] Preserve existing Lip Gloss rendering pattern

- [ ] Handle edge cases (AC: 1, 4)
  - [ ] Handle empty actions list (existing placeholder logic works)
  - [ ] Handle single action (should display in 1 column)
  - [ ] Handle very short panels (minimum 1 item per column, add more columns as needed)
  - [ ] Handle many actions (gracefully add more columns)
  - [ ] Ensure no division by zero when availableHeight <= 0
  - [ ] Add minimum height check (if height < 6, use fallback layout)

- [ ] Update tests for dynamic column layout (AC: 4)
  - [ ] Update `internal/tui/app_test.go` if actions panel tests exist
  - [ ] Test with varying action counts and panel heights:
    - 3 actions, height 10 → should use 1 column
    - 10 actions, height 8 → should use 2 columns
    - 20 actions, height 8 → should use 3+ columns
  - [ ] Test edge cases (empty, single action, very short panel)
  - [ ] Verify no regression in action execution functionality
  - [ ] Verify visual layout with different terminal sizes

- [ ] Manual testing and validation (All ACs)
  - [ ] Launch kubertino with 3 actions → verify 1 column displayed
  - [ ] Launch kubertino with 10 actions → verify multiple columns if needed
  - [ ] Resize terminal vertically (decrease height) → verify columns increase
  - [ ] Resize terminal vertically (increase height) → verify columns decrease
  - [ ] Test with 2, 5, 10, 20 actions to verify dynamic column calculation
  - [ ] Verify action shortcuts still work from all panels
  - [ ] Verify visual consistency with other panels

## Dev Notes

### Current Implementation Analysis

**File:** `internal/tui/app.go` (lines 1216-1277)

**Current Algorithm (Width-Based Columns):**
```go
// Lines 1228-1231: Column count based on WIDTH (PROBLEM)
columnCount := 2
if width >= 80 {
    columnCount = 3
}

// Lines 1233: Items per column (vertical distribution)
itemsPerColumn := (len(m.actions) + columnCount - 1) / columnCount

// Lines 1235-1255: Loop through columns, render items vertically
for col := 0; col < columnCount; col++ {
    // Build each column vertically
    for i := start; i < end; i++ {
        // Add action to column
    }
    columns = append(columns, lipgloss.JoinVertical(lipgloss.Left, columnLines...))
}

// Line 1257: Join columns horizontally
content = lipgloss.JoinHorizontal(lipgloss.Top, columns...)
```

**Problem:**
- Column count is **fixed** based on panel width (always 2 or 3 columns)
- This ignores the number of actions and available height
- With 3 actions and lots of height → wastes space by using 2 columns
- With 20 actions and limited height → items may not fit visibly

**Need:** Dynamic column calculation based on **HEIGHT** and number of actions

### Required Changes

**New Algorithm (Height-Based Columns):**
```go
// Calculate available height for action items
// Reserve space for: border (2), padding (2), title (1), blank (1), help text (2) = 8 lines
contentHeight := height - 8
if contentHeight < 1 {
    contentHeight = 1 // Minimum
}

// Calculate minimum columns needed based on available height
// If all actions fit in one column → use 1 column
// Otherwise calculate: ceil(totalActions / availableHeight)
columnCount := 1
if len(m.actions) > contentHeight {
    // Need multiple columns
    columnCount = (len(m.actions) + contentHeight - 1) / contentHeight
}

// Calculate items per column (distribute evenly)
itemsPerColumn := (len(m.actions) + columnCount - 1) / columnCount

// Build columns (KEEP EXISTING RENDERING LOGIC)
var columns []string
for col := 0; col < columnCount; col++ {
    var columnLines []string
    start := col * itemsPerColumn
    end := start + itemsPerColumn
    if end > len(m.actions) {
        end = len(m.actions)
    }

    for i := start; i < end; i++ {
        action := m.actions[i]
        shortcut := styles.ShortcutStyle.Render(fmt.Sprintf("[%s]", action.Shortcut))
        actionName := styles.ActionStyle.Render(action.Name)
        line := fmt.Sprintf("%s %s", shortcut, actionName)
        columnLines = append(columnLines, line)
    }

    if len(columnLines) > 0 {
        columns = append(columns, lipgloss.JoinVertical(lipgloss.Left, columnLines...))
    }
}

// Join columns horizontally (KEEP EXISTING)
content = lipgloss.JoinHorizontal(lipgloss.Top, columns...)
```

**Key Changes:**
1. **Lines to modify:** Only lines 1228-1231 (column count calculation)
2. **OLD:** `columnCount = 2 or 3` based on width
3. **NEW:** `columnCount = ceil(actions / availableHeight)` based on height
4. **Keep everything else:** Column rendering, formatting, styling all stay the same

### Architecture Context

**Component:** TUI Controller - Actions Panel Model
**Location:** `internal/tui/app.go`
**Pattern:** Lip Gloss declarative styling and layout composition

**Key Architectural Principles:**
- Lip Gloss uses `JoinHorizontal` for left-to-right composition
- Lip Gloss uses `JoinVertical` for top-to-bottom composition
- Panel dimensions calculated from terminal size (Story 3.1)
- Actions panel is non-focusable (Story 6.2)

**Related Components:**
- `internal/tui/styles/styles.go` - Style definitions (ShortcutStyle, ActionStyle)
- `internal/config/config.go` - Action data structure

### Example Visual Layout

**Before (Fixed Width-Based Columns):**
```
Actions (3 items, always 2 columns)
-------------------
[c] Console    [l] Logs
[b] Bash
```
Problem: Wastes horizontal space when few actions

**After (Dynamic Height-Based Columns):**

**Scenario 1: 3 actions, height 10 lines → 1 column**
```
Actions
-----------
[c] Console
[b] Bash
[l] Logs
```

**Scenario 2: 10 actions, height 6 lines → 2 columns**
```
Actions
-------------------------
[c] Console       [p] Port Forward
[b] Bash          [o] Dashboard
[l] Logs          [r] Restart
[d] Describe      [s] Scale
[e] Events        [x] Delete
```

**Scenario 3: 20 actions, height 6 lines → 4 columns**
```
Actions
-----------------------------------------------
[c] Console    [f] File       [k] Kill      [u] Update
[b] Bash       [g] Get        [l] Logs      [v] View
[d] Describe   [h] Help       [m] Monitor   [w] Watch
[e] Events     [i] Info       [n] Network   [x] Delete
[j] Jobs       [o] Open       [p] Port      [y] YAML
```

### Testing Strategy

**Unit Tests:**
- Test column calculation logic with various action counts and panel heights
- Test edge cases (empty, single action, very short panel, many actions)
- Verify column count calculation: `ceil(actions / availableHeight)`

**Test Cases:**
1. `3 actions, height 10` → expect `columnCount = 1`
2. `10 actions, height 5` → expect `columnCount = 2`
3. `20 actions, height 5` → expect `columnCount = 4`
4. `1 action, any height` → expect `columnCount = 1`
5. `0 actions` → expect empty state placeholder

**Manual Testing Checklist:**
1. Load config with 3 actions → verify 1 column displayed
2. Load config with 10 actions → verify multiple columns based on height
3. Load config with 20 actions → verify more columns
4. Resize terminal vertically (decrease height) → verify columns increase
5. Resize terminal vertically (increase height) → verify columns decrease
6. Test action shortcuts → verify all still work from any panel
7. Tab between panels → verify actions panel not in focus cycle (Story 6.2)

**Coverage Requirement:** Existing coverage maintained (>80% for TUI components)

### Relevant Source Tree

```
internal/tui/
├── app.go                      # Lines 1216-1277: renderActionsPanel() - MODIFY
├── app_test.go                 # May need updates if actions tests exist
└── styles/
    └── styles.go               # Action styling (ShortcutStyle, ActionStyle)
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-12 | 1.0 | Initial story - dynamic column layout based on height | PO (Sarah) |
