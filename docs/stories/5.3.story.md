# Story 5.3: Implement Favorites Dual-Format Support

## Status

Ready for Review

## Story

**As a** user,
**I want** to configure favorites as per-context map OR global list,
**so that** I have flexibility in organizing my namespaces.

## Acceptance Criteria

1. Config parser detects favorites format (map vs list)
2. Per-context format: favorites[context_name] returns []string for selected context
3. Global format: favorites returns []string for all contexts
4. Namespace panel displays favorites based on current context
5. Visual separator between favorites and regular namespaces
6. Favorites sorted alphabetically within their section
7. Empty favorites handled gracefully (no separator shown)
8. Unit tests cover both formats and edge cases

## Tasks / Subtasks

- [x] Integrate GetFavorites into TUI namespace loading (AC: 1, 2, 3, 4)
  - [x] Import config.GetFavorites function in internal/tui/app.go
  - [x] Call GetFavorites when loading namespaces for current context
  - [x] Store favorites list in AppModel state (add favoriteNamespaces []string field)
  - [x] Handle GetFavorites errors gracefully (log but don't block namespace display)
  - [x] Update namespace sorting to separate favorites from regular namespaces

- [x] Implement favorites display with visual separator (AC: 4, 5, 7)
  - [x] Modify renderNamespacesPanel to show favorites first
  - [x] Add visual separator line between favorites and regular namespaces
  - [x] Use existing sortNamespacesWithFavorites helper function
  - [x] Only show separator if favorites list is non-empty
  - [x] Apply different styling to favorites section (subtle highlight or marker)

- [x] Sort favorites and regular namespaces alphabetically (AC: 6)
  - [x] Sort favorites slice alphabetically before display
  - [x] Sort regular namespaces slice alphabetically after removing favorites
  - [x] Preserve user's selected namespace index after sorting

- [x] Update search mode to work with favorites (AC: 4)
  - [x] Ensure fuzzy search filters both favorites and regular namespaces
  - [x] Maintain favorites section in filtered results
  - [x] Update filtered namespace indices correctly

- [x] Unit tests for favorites integration (AC: 8)
  - [x] Test AppModel with per-context favorites format
  - [x] Test AppModel with global favorites format
  - [x] Test favorites display with empty favorites list
  - [x] Test namespace sorting with favorites
  - [x] Test fuzzy search with favorites present
  - [x] Test context switching preserves favorites correctly
  - [x] Achieve 70%+ coverage for modified TUI functions

## Dev Notes

### Previous Story Insights

[Source: Story 5.1 Dev Agent Record]
- Story 5.1 refactored config model to include Config.Favorites (dual-format support)
- Parser functions already implemented: parseFavorites() and GetFavorites()
- GetFavorites(config, contextName) returns []string of favorite namespaces for given context
- Supports two formats: map[string][]string (per-context) or []string (global)
- Validation already handles both formats during config load
- Per-context format: favorites["production"] = ["ns1", "ns2"]
- Global format: favorites = ["ns1", "ns2"] (applies to all contexts)

[Source: Story 5.2 Dev Agent Record]
- Story 5.2 noted TUI integration issues after config model changes
- Dev agent added TODO comments in app.go for favorites implementation
- Existing helper function sortNamespacesWithFavorites() available but not currently used
- Lines 205, 839, 990 in app.go have TODO comments for favorites implementation

### Architecture Context

[Source: architecture.md#Data Models - Configuration Model]

**Favorites Dual-Format Support:**

The Config.Favorites field supports two formats for maximum flexibility:

**Format A: Per-Context Map**
```yaml
favorites:
  production:
    - critical-app
    - monitoring
  staging:
    - staging-app
```

**Format B: Global List**
```yaml
favorites:
  - my-namespace
  - another-namespace
```

**Implementation Pattern:**
```go
// Get favorites for current context
favorites, err := config.GetFavorites(m.config, m.currentContext.Name)
if err != nil {
    slog.Warn("failed to get favorites", "context", m.currentContext.Name, "error", err)
    favorites = []string{} // Use empty list on error
}

// Sort namespaces with favorites first
sortedNamespaces := m.sortNamespacesWithFavorites(allNamespaces, favorites)
```

[Source: architecture.md#Components - TUI Controller]

**Namespace Panel Display Pattern:**

The namespace panel should display:
1. Favorites section (if non-empty)
2. Visual separator (only if favorites exist)
3. Regular namespaces section

**Visual Hierarchy:**
```
┌─ Namespaces (Production) ─────┐
│ ★ critical-app                │  <- Favorite
│ ★ monitoring                  │  <- Favorite
│ ────────────────────────────  │  <- Separator
│   app-namespace               │  <- Regular
│   default                     │  <- Regular
│   kube-system                 │  <- Regular
└────────────────────────────────┘
```

### File Locations

[Source: architecture.md#Source Tree]

**Files to modify:**
- `internal/tui/app.go` - Integrate GetFavorites, update namespace sorting and display
- `internal/tui/app_test.go` - Add unit tests for favorites display logic

**Files to reference:**
- `internal/config/parser.go` - GetFavorites() function (line 119)
- `internal/config/config.go` - Config.Favorites field definition (line 10)
- `internal/tui/app.go` - sortNamespacesWithFavorites() helper (line 529)

**No new files needed** - extend existing TUI package.

### Technical Details

[Source: internal/config/parser.go]

**GetFavorites Function Signature:**
```go
func GetFavorites(config *Config, contextName string) ([]string, error)
```

**Usage Pattern:**
```go
favorites, err := config.GetFavorites(m.config, m.currentContext.Name)
if err != nil {
    // Log warning but don't block namespace display
    slog.Warn("failed to get favorites", "context", m.currentContext.Name, "error", err)
    favorites = []string{}
}
```

**Error Handling:**
- GetFavorites returns error if favorites format is invalid (should not happen after validation)
- Per-context format returns empty list if context not found in favorites map
- Global format returns full list for all contexts
- TUI should log errors but continue with empty favorites list (graceful degradation)

[Source: internal/tui/app.go:529]

**Existing Helper Function:**
```go
// sortNamespacesWithFavorites sorts namespaces with favorites first
func (m AppModel) sortNamespacesWithFavorites(namespaces []string, favorites []string) []string {
    // Implementation already exists
    // Separates favorites from regular namespaces
    // Returns sorted list with favorites first
}
```

**Visual Separator Implementation:**
```go
// In renderNamespacesPanel:
if len(favorites) > 0 {
    // Render favorites section
    for _, ns := range favorites {
        fmt.Fprintf(&buf, "★ %s\n", ns)
    }
    // Render separator
    fmt.Fprintf(&buf, "────────────────\n")
}
// Render regular namespaces
for _, ns := range regularNamespaces {
    fmt.Fprintf(&buf, "  %s\n", ns)
}
```

### TUI Integration Points

[Source: internal/tui/app.go]

**Integration Points:**

1. **Namespace Loading (handleNamespacesFetched):**
   - After fetching namespaces, call GetFavorites
   - Store favorites in AppModel state
   - Sort namespaces with favorites first

2. **Namespace Rendering (renderNamespacesPanel):**
   - Render favorites section with visual marker (★)
   - Show separator if favorites exist
   - Render regular namespaces section

3. **Search Mode (filterNamespaces):**
   - Fuzzy search should filter both favorites and regular namespaces
   - Maintain favorites section in filtered results

4. **Context Switching:**
   - Re-fetch favorites when context changes
   - Update namespace display with new context's favorites

**AppModel State Addition:**
```go
type AppModel struct {
    // Existing fields...
    favoriteNamespaces []string // Favorite namespaces for current context
}
```

### Styling

[Source: internal/tui/styles/styles.go]

**Favorites Marker:**
- Use "★" character to mark favorite namespaces
- Apply subtle color highlight (optional, use lipgloss.Color)

**Separator Style:**
- Simple horizontal line: "────────────────"
- Use panel border color for consistency
- Only render if len(favorites) > 0

**Example:**
```go
favoriteStyle := lipgloss.NewStyle().Foreground(lipgloss.Color("226")) // Yellow star
separatorStyle := lipgloss.NewStyle().Foreground(lipgloss.Color("240")) // Gray
```

### Search Integration

[Source: internal/tui/app.go - search mode]

**Fuzzy Search with Favorites:**

When search mode is active:
1. Filter both favorites and regular namespaces using fuzzy matcher
2. Maintain separation in filtered results (favorites still first)
3. Update visual separator visibility based on filtered favorites count

**Example Flow:**
```go
if m.searchMode {
    allNamespaces := append(m.favoriteNamespaces, m.regularNamespaces...)
    m.filteredNamespaces = fuzzy.Filter(m.searchQuery, allNamespaces)
    
    // Re-separate filtered results
    filteredFavorites := []string{}
    filteredRegular := []string{}
    for _, ns := range m.filteredNamespaces {
        if contains(m.favoriteNamespaces, ns) {
            filteredFavorites = append(filteredFavorites, ns)
        } else {
            filteredRegular = append(filteredRegular, ns)
        }
    }
}
```

### Edge Cases

**Empty Favorites:**
- GetFavorites returns empty list for context without favorites
- Separator should NOT be rendered
- Display flows directly to regular namespaces

**All Namespaces Are Favorites:**
- Render only favorites section
- No separator needed
- Regular namespaces section empty

**Namespace Exists in Both Favorites and Regular:**
- Should not happen in practice
- If it does, show only in favorites section (deduplicate)

**Context Switch:**
- Clear previous favorites when switching contexts
- Fetch new favorites for new context
- Update display immediately

### Testing

[Source: architecture.md#Test Strategy and Standards]

**Test Framework:**
- Go stdlib `testing` package
- Testify library for assertions (`testify/assert`, `testify/require`)
- Table-driven test pattern for multiple scenarios

**Test File Location:**
- `internal/tui/app_test.go` - Add tests for favorites integration

**Coverage Requirement:**
- Minimum 70% coverage for modified TUI functions

**Test Categories:**

**Unit Tests for GetFavorites Integration:**
- Per-context favorites format with matching context
- Per-context favorites format with non-matching context
- Global favorites format
- Empty favorites (nil or empty list)
- GetFavorites error handling (invalid format)

**Unit Tests for Favorites Display:**
- Favorites displayed before regular namespaces
- Visual separator shown when favorites exist
- Visual separator not shown when favorites empty
- Favorites sorted alphabetically
- Regular namespaces sorted alphabetically

**Unit Tests for Search with Favorites:**
- Fuzzy search filters both sections
- Filtered results maintain favorites/regular separation
- Empty search shows all namespaces with favorites first

**Unit Tests for Context Switching:**
- Favorites updated when context changes
- Per-context favorites show correct list per context
- Global favorites show same list for all contexts

**Example Test Structure:**
```go
func TestFavoritesDisplay(t *testing.T) {
    tests := []struct {
        name            string
        config          *config.Config
        contextName     string
        allNamespaces   []string
        wantFavorites   []string
        wantSeparator   bool
    }{
        {
            name: "per-context favorites with matches",
            config: &config.Config{
                Favorites: map[string]interface{}{
                    "production": []interface{}{"critical", "monitoring"},
                },
            },
            contextName: "production",
            allNamespaces: []string{"app", "critical", "default", "monitoring"},
            wantFavorites: []string{"critical", "monitoring"},
            wantSeparator: true,
        },
        {
            name: "empty favorites - no separator",
            config: &config.Config{
                Favorites: []interface{}{},
            },
            contextName: "production",
            allNamespaces: []string{"app", "default"},
            wantFavorites: []string{},
            wantSeparator: false,
        },
        // More test cases...
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            model := AppModel{
                config: tt.config,
                currentContext: &config.Context{Name: tt.contextName},
            }
            
            favorites, err := config.GetFavorites(model.config, model.currentContext.Name)
            require.NoError(t, err)
            assert.Equal(t, tt.wantFavorites, favorites)
            
            // Test display rendering
            view := model.renderNamespacesPanel()
            if tt.wantSeparator {
                assert.Contains(t, view, "────")
            } else {
                assert.NotContains(t, view, "────")
            }
        })
    }
}
```

**Manual Testing Checklist:**

1. Create config with per-context favorites
2. Launch kubertino, select production context
3. Verify favorites displayed first with separator
4. Switch to staging context
5. Verify different favorites displayed
6. Create config with global favorites
7. Verify same favorites shown for all contexts
8. Test search mode with favorites present
9. Verify favorites appear in filtered results

## Dev Agent Record

### Implementation Summary

Successfully integrated favorites dual-format support into the TUI namespace panel. The implementation:

1. **Added favoriteNamespaces field** to AppModel state (line 107)
2. **Integrated GetFavorites** in namespaceFetchedMsg handler (lines 206-215)
3. **Enhanced sortNamespacesWithFavorites** to sort both sections alphabetically (lines 540-583)
4. **Updated namespace rendering** to display favorites with star markers and visual separator (lines 869-972)
5. **Context switching** properly clears and reloads favorites (line 320)
6. **Search mode compatibility** maintained - favorites marked in filtered results

### Visual Implementation

- **Star marker (★)** indicates favorite namespaces
- **Separator line (────)** shown only when favorites exist and regular namespaces follow
- Both favorites and regular namespaces sorted alphabetically within their sections
- Search mode preserves favorite markers but doesn't show separator

### Test Coverage

Added comprehensive tests in `internal/tui/app_test.go`:

- **TestFavoritesIntegration** - Tests per-context, global, empty, and nil favorites formats
- **TestSortNamespacesWithFavorites** - Tests alphabetical sorting of both sections
- **TestFavoritesDisplay** - Tests visual rendering with star markers and separator
- **TestContextSwitchingWithFavorites** - Tests favorites reload on context change

**Coverage**: 82.6% (exceeds 70% requirement)

### Files Modified

- `internal/tui/app.go` - Added favoriteNamespaces field, integrated GetFavorites, enhanced sorting, updated rendering
- `internal/tui/app_test.go` - Added 4 new test functions with 15 test cases

### Edge Cases Handled

1. **Empty favorites** - No separator shown, all namespaces treated as regular
2. **Nil favorites** - Gracefully handled as empty list
3. **All namespaces are favorites** - No separator shown
4. **GetFavorites errors** - Logged as warning, continues with empty favorites list
5. **Search mode** - Favorites marked but separator not shown in filtered results
6. **Context switching** - Favorites cleared and reloaded with new namespace fetch

### Completion Notes

All acceptance criteria met:
- ✅ AC1: Config parser detects favorites format (already implemented in Story 5.1)
- ✅ AC2: Per-context format returns correct namespaces
- ✅ AC3: Global format returns same list for all contexts
- ✅ AC4: Namespace panel displays favorites based on current context
- ✅ AC5: Visual separator between favorites and regular namespaces
- ✅ AC6: Favorites sorted alphabetically within their section
- ✅ AC7: Empty favorites handled gracefully (no separator)
- ✅ AC8: Unit tests cover both formats and edge cases

All tests pass. Test coverage: 82.6%. Ready for QA review.

### File List

**Modified:**
- `internal/tui/app.go` - Added favoriteNamespaces field, integrated GetFavorites, enhanced sorting, updated rendering
- `internal/tui/app_test.go` - Added comprehensive favorites integration tests

**No files created or deleted**

## QA Results

### Review Date: 2025-10-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of favorites dual-format support. The integration is clean, well-tested, and handles all edge cases gracefully. The code follows Go best practices and integrates seamlessly with the existing TUI architecture. Visual presentation with star markers and separators is intuitive and user-friendly.

### Refactoring Performed

- **File**: internal/tui/app.go
  - **Change**: Replaced bubble sort (O(n²)) with sort.Strings() (O(n log n)) for alphabetical sorting
  - **Why**: Bubble sort implementation (lines 564-578) was inefficient and reinvented standard library functionality
  - **How**: Imported `sort` package and used `sort.Strings(favs)` and `sort.Strings(nonFavs)` for cleaner, more performant code. Reduces sorting time from O(n²) to O(n log n), which matters for clusters with many namespaces.

### Compliance Check

- **Coding Standards**: ✓ Follows Go naming conventions, proper error handling, appropriate use of slog
- **Project Structure**: ✓ Changes isolated to internal/tui package, maintains existing architecture
- **Testing Strategy**: ✓ Table-driven tests, 82.4% coverage (exceeds 70% requirement), comprehensive edge cases
- **All ACs Met**: ✓ All 8 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Refactored sorting algorithm from bubble sort to stdlib sort.Strings (internal/tui/app.go:564-565)
- [x] Verified test coverage exceeds 70% requirement (82.4% actual)
- [x] Validated favorites display in both normal and search modes
- [x] Confirmed error handling for GetFavorites failures (graceful degradation)
- [x] Verified context switching properly clears and reloads favorites

### Security Review

No security concerns. The implementation handles configuration parsing defensively with proper error handling. GetFavorites returns errors instead of panicking on invalid formats. No user input is processed directly - all data comes from pre-validated configuration.

### Performance Considerations

**Improved**: Refactored sorting from O(n²) bubble sort to O(n log n) stdlib implementation. For typical namespace counts (20-100), this reduces sort time from ~5000 comparisons to ~500 comparisons at 100 items.

**Strengths**: 
- Lazy loading maintained (only favorites for current context)
- Efficient map-based favorite lookup (O(1) per namespace)
- Minimal memory overhead (single favoriteNamespaces slice)

### Files Modified During Review

- internal/tui/app.go - Added `sort` import, replaced bubble sort with sort.Strings()

**Dev**: Please update File List to include this refactoring change.

### Gate Status

Gate: **PASS** → docs/qa/gates/5.3-favorites-dual-format-support.yml

### Recommended Status

✓ **Ready for Done**

All acceptance criteria met with excellent test coverage. Implementation is clean, performant, and maintainable. Refactoring improves performance without changing behavior. Ready for production deployment.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-06 | 1.0 | Initial story creation | SM (Bob) |
| 2025-10-06 | 2.0 | Implemented favorites dual-format TUI integration | DEV (James) |
| 2025-10-06 | 2.1 | QA Review: PASS with performance refactoring | QA (Quinn) |

