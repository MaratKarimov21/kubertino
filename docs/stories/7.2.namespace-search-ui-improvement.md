# Story 7.2: Namespace Search UI Improvement - Fixed Panel Size and Highlighted Search Box

## Status

Draft

## Story

**As a** Kubernetes developer,
**I want** поле поиска с желтой рамкой и фиксированным размером панели неймспейсов,
**so that** поиск выглядит более профессионально и панель не прыгает при активации поиска.

## Story Context

### Existing System Integration

- **Integrates with:** Namespace panel search functionality in `internal/tui/app.go` (Story 2.2)
- **Technology:** Bubble Tea TUI framework, Lip Gloss styling library
- **Follows pattern:** Border styling patterns from `internal/tui/styles/styles.go`
- **Touch points:**
  - `renderNamespaceList()` method in `internal/tui/app.go` (lines 804-965)
  - `adjustNamespaceViewport()` method in `internal/tui/app.go` (lines 601-686)
  - `renderNamespacePanel()` method in `internal/tui/app.go` (lines 1077-1106)
  - Search mode state management (`searchMode`, `searchQuery` fields)

### Current Implementation Analysis

**Current behavior (Story 2.2):**
- Search activated with `/` key
- Search box renders as plain text: `"Search: " + m.searchQuery + "_"`
- No visual borders or framing around search input
- Panel height calculation includes `searchBoxLines = 2` which causes panel to shrink when search is activated
- Search box appears at lines 948-952 in `renderNamespaceList()`

**Problem identified:**
1. **Panel size changes:** When search mode activates, `searchBoxLines = 2` is added to `reservedLines` calculation in `adjustNamespaceViewport()` (line 628), reducing `availableHeight` and causing the namespace list viewport to shrink
2. **No visual highlighting:** Search box is plain text with `NormalStyle`, making it hard to distinguish from the namespace list

## Acceptance Criteria

### Functional Requirements

1. При активации поиска (клавиша `/`) размер панели неймспейсов остается неизменным (не сжимается)
2. Поле поиска отображается с желтой рамкой используя Lip Gloss Border
3. Label "Search" центрирован и размещен на верхней границе рамки (используя Lip Gloss border title)
4. Существующая функциональность поиска (фильтрация по fuzzy search, навигация Up/Down, ESC для отмены) работает без изменений

### Integration Requirements

5. Existing namespace panel functionality continues to work unchanged (navigation, selection, favorites display)
6. Search mode activation/deactivation (/ key and ESC key) maintains current behavior
7. Integration with fuzzy search (`internal/search/fuzzy.go`) remains intact

### Quality Requirements

8. Changes covered by tests (update existing tests in `internal/tui/search_test.go` and `internal/tui/app_test.go`)
9. Visual testing confirms proper rendering of yellow-bordered search box with "Search" title
10. No regression in existing search functionality tests

## Technical Notes

### Integration Approach

This enhancement modifies the **visual presentation and viewport calculation** of the namespace search box. The underlying search logic (fuzzy matching, query update, filtering) remains unchanged.

**Key changes:**
1. Modify `renderNamespaceList()` to render search box with yellow border and "Search" title
2. Fix `adjustNamespaceViewport()` to use fixed panel height (remove dynamic `searchBoxLines` from calculation)
3. Add new `SearchBoxStyle` to `internal/tui/styles/styles.go`

### Files to Modify

**1. `/Users/maratkarimov/GolandProjects/kubertino/internal/tui/styles/styles.go`**

Add new style for search box:
```go
// SearchBoxStyle is used for the search input box (Story 7.2)
// Yellow border with rounded corners, "Search" title on border
SearchBoxStyle = lipgloss.NewStyle().
    Border(lipgloss.RoundedBorder()).
    BorderForeground(lipgloss.Color("226")). // Yellow
    Padding(0, 1).
    Align(lipgloss.Center)
```

**2. `/Users/maratkarimov/GolandProjects/kubertino/internal/tui/app.go`**

**Modify `renderNamespaceList()` (lines 948-952):**

Current code:
```go
// Search input box (if search mode active)
if m.searchMode {
    s += "\n"
    searchBox := "Search: " + m.searchQuery + "_"
    s += styles.NormalStyle.Render(searchBox) + "\n"
}
```

New code:
```go
// Search input box (if search mode active) - Story 7.2: Yellow bordered box with title
if m.searchMode {
    s += "\n"
    searchContent := m.searchQuery + "_"

    // Apply yellow border with "Search" title
    searchBoxStyle := lipgloss.NewStyle().
        Border(lipgloss.RoundedBorder()).
        BorderForeground(lipgloss.Color("226")). // Yellow
        Padding(0, 1)

    // Render with title
    searchBox := searchBoxStyle.Render(searchContent)

    // Add "Search" as border title (centered)
    styledBox := lipgloss.NewStyle().
        BorderTop(true).
        BorderStyle(lipgloss.RoundedBorder()).
        BorderForeground(lipgloss.Color("226")).
        Render(searchBox)

    s += styledBox + "\n"
}
```

**Note:** Lip Gloss doesn't support border titles directly. Alternative approach:
- Render "Search" label above the bordered box
- Or use a custom rendering with border characters

Simpler implementation:
```go
// Search input box (if search mode active) - Story 7.2: Yellow bordered box
if m.searchMode {
    s += "\n"

    // Render "Search" label centered above box
    searchLabel := lipgloss.NewStyle().
        Foreground(lipgloss.Color("226")). // Yellow
        Bold(true).
        Render("Search")

    // Render search input with yellow border
    searchContent := m.searchQuery + "_"
    searchBox := lipgloss.NewStyle().
        Border(lipgloss.RoundedBorder()).
        BorderForeground(lipgloss.Color("226")). // Yellow
        Padding(0, 1).
        Width(30). // Fixed width or calculate based on panel width
        Render(searchContent)

    s += searchLabel + "\n"
    s += searchBox + "\n"
}
```

**Modify `adjustNamespaceViewport()` (lines 620-630):**

Current code calculates `searchBoxLines` dynamically:
```go
searchBoxLines := 0
if m.searchMode {
    searchBoxLines = 2
}

reservedLines := headerLines + footerLines + searchBoxLines
availableHeight := effectiveHeight - reservedLines - scrollIndicatorLines
```

**Fix:** Use a fixed reservation for search box space (always reserve space, whether search is active or not):
```go
// Story 7.2: Always reserve space for search box (fixed panel size)
searchBoxLines := 3 // Label (1) + bordered box (1) + blank (1)

reservedLines := headerLines + footerLines + searchBoxLines
availableHeight := effectiveHeight - reservedLines - scrollIndicatorLines
```

This ensures `availableHeight` doesn't change when search mode activates.

**Alternative approach (preferred):**
```go
// Story 7.2: Fixed panel layout - don't adjust reserved lines based on search mode
headerLines := 2
footerLines := 2
scrollIndicatorLines := 1
fixedReservedLines := 3 // Fixed space for search box area (always present)

reservedLines := headerLines + footerLines + fixedReservedLines
availableHeight := effectiveHeight - reservedLines - scrollIndicatorLines
if availableHeight < 1 {
    availableHeight = 1
}
```

**3. `/Users/maratkarimov/GolandProjects/kubertino/internal/tui/app.go` - `renderNamespacePanel()`**

Verify that `contentHeight` calculation remains correct (no changes needed, but document):
```go
// Line 1086: Calculate available height for content (what renderNamespaceList will receive)
// CRITICAL: This must match the effectiveHeight used in adjustNamespaceViewport!
contentHeight := height - 4 // Subtract border (2) + padding (2)
```

This should remain unchanged, but add a comment referencing Story 7.2.

### Existing Pattern Reference

**Border styles from `internal/tui/styles/styles.go`:**
- `ErrorStyle` uses `lipgloss.Color("9")` (Red) with `lipgloss.RoundedBorder()`
- `FocusedPanelBorderStyle` uses `lipgloss.Color("39")` (Bright cyan)
- `UnfocusedPanelBorderStyle` uses `lipgloss.Color("240")` (Gray)

**New color for search box:**
- Yellow: `lipgloss.Color("226")` - bright, visible, indicates input mode

**Viewport calculation pattern:**
- Always used in `adjustNamespaceViewport()` to determine visible namespace range
- Must account for all UI elements: header, footer, scroll indicators, search box
- Story 7.2 makes this calculation fixed (not dynamic based on search mode)

### Key Constraints

- **Fixed panel size:** Panel height must not change when search mode activates/deactivates
- **Backward compatibility:** All Story 2.2 search tests must pass without major modification
- **Color consistency:** Yellow (`226`) chosen to be distinct from existing colors (cyan=focus, gray=unfocused, red=error)
- **Lip Gloss limitations:** No native border title support, so use label above box approach

### Implementation Approach Summary

**Step 1:** Add `SearchBoxStyle` to `styles.go` (yellow border)
**Step 2:** Modify `renderNamespaceList()` to render search box with yellow border and "Search" label
**Step 3:** Fix `adjustNamespaceViewport()` to use fixed reserved lines (not dynamic based on `searchMode`)
**Step 4:** Test with existing tests and manual testing (activate search, verify panel doesn't shrink)

## Definition of Done

- [ ] Functional requirements met
- [ ] Search box renders with yellow border when search mode active
- [ ] "Search" label displayed (centered above border)
- [ ] Namespace panel size remains fixed when search activates/deactivates
- [ ] Integration requirements verified
- [ ] Existing search functionality works (fuzzy search, navigation, ESC to cancel)
- [ ] Namespace selection and pod loading work after search
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing search tests in `internal/tui/search_test.go`)
- [ ] Visual confirmation: search box has yellow border with "Search" label
- [ ] Visual confirmation: panel height doesn't change when pressing `/`

## Risk Assessment

### Primary Risk

Viewport calculation changes might break scrolling behavior for namespaces, causing cursor to go out of bounds or list to display incorrectly.

### Mitigation

- Carefully review `adjustNamespaceViewport()` logic
- Test with various namespace counts (5, 20, 50, 100 namespaces)
- Test with different terminal sizes (80x24, 120x30, 160x40)
- Verify cursor centering behavior still works (Story 6.1)
- Run full test suite: `go test ./internal/tui/...`

### Rollback

Simple rollback to previous implementation:
1. Revert `renderNamespaceList()` search box rendering
2. Revert `adjustNamespaceViewport()` to dynamic `searchBoxLines` calculation
3. Remove `SearchBoxStyle` from `styles.go`

No database or config changes involved.

## Compatibility Verification

- [x] No breaking changes to existing APIs (only internal rendering methods modified)
- [x] No database changes needed
- [x] UI changes follow existing design patterns (Lip Gloss borders)
- [x] Performance impact is negligible (same rendering logic, just styled differently)

## Dev Notes

### Relevant Source Tree

Based on architecture.md#Source Tree and existing stories:
- **Main file to modify:** `internal/tui/app.go`
  - `renderNamespaceList()` lines 804-965 (search box rendering)
  - `adjustNamespaceViewport()` lines 601-686 (viewport calculation)
  - `renderNamespacePanel()` line 1086 (content height - no changes needed)
- **Styles file:** `internal/tui/styles/styles.go` (add SearchBoxStyle)
- **Tests location:** `internal/tui/search_test.go`, `internal/tui/app_test.go`

### Testing Standards

From architecture.md#Test Strategy:
- **Test file location:** `internal/tui/search_test.go` (co-located with app.go)
- **Framework:** Go stdlib `testing` package with `testify/assert`
- **Coverage requirement:** Maintain 70%+ coverage
- **Style:** Table-driven tests

**Test scenarios to verify:**
1. Search mode activation: panel size doesn't change
2. Search box renders with yellow border
3. Fuzzy search filtering still works
4. ESC cancels search and removes search box
5. Enter selects namespace and exits search
6. Viewport scrolling works correctly with fixed reserved space

**Existing tests to update (if needed):**
- `internal/tui/search_test.go` - may need to update visual expectations for search box rendering
- `internal/tui/app_test.go` - verify no regressions in namespace panel tests

### Important Constraints

**From architecture.md#Coding Standards:**
- Use `gofmt` for formatting
- Follow existing naming conventions (camelCase for private methods)
- Do not introduce global mutable state
- Maintain 70%+ test coverage

**Performance considerations:**
- No additional kubectl calls or data fetching
- Same fuzzy search logic (no performance impact)
- Lip Gloss rendering overhead is negligible

### Detailed Implementation Steps

**Step 1: Add SearchBoxStyle to styles.go**

Location: After line 162 in `internal/tui/styles/styles.go`

```go
// SearchBoxStyle is used for the search input box (Story 7.2)
// Yellow border with rounded corners and padding
SearchBoxStyle = lipgloss.NewStyle().
    Border(lipgloss.RoundedBorder()).
    BorderForeground(lipgloss.Color("226")). // Yellow
    Padding(0, 1)

// SearchLabelStyle is used for "Search" label above search box (Story 7.2)
// Yellow text with bold
SearchLabelStyle = lipgloss.NewStyle().
    Foreground(lipgloss.Color("226")). // Yellow
    Bold(true)
```

**Step 2: Modify renderNamespaceList() search box rendering**

Location: Lines 948-952 in `internal/tui/app.go`

Replace:
```go
// Search input box (if search mode active)
if m.searchMode {
    s += "\n"
    searchBox := "Search: " + m.searchQuery + "_"
    s += styles.NormalStyle.Render(searchBox) + "\n"
}
```

With:
```go
// Search input box (if search mode active) - Story 7.2: Yellow bordered box with label
if m.searchMode {
    s += "\n"

    // Render "Search" label (centered, yellow)
    searchLabel := styles.SearchLabelStyle.Render("Search")
    s += searchLabel + "\n"

    // Render search input with yellow border
    searchContent := m.searchQuery + "_"
    searchBox := styles.SearchBoxStyle.Render(searchContent)
    s += searchBox + "\n"
}
```

**Step 3: Fix adjustNamespaceViewport() to use fixed reserved space**

Location: Lines 620-630 in `internal/tui/app.go`

Replace:
```go
headerLines := 2
footerLines := 2
scrollIndicatorLines := 1
searchBoxLines := 0
if m.searchMode {
    searchBoxLines = 2
}

reservedLines := headerLines + footerLines + searchBoxLines
availableHeight := effectiveHeight - reservedLines - scrollIndicatorLines
```

With:
```go
headerLines := 2
footerLines := 2
scrollIndicatorLines := 1
// Story 7.2: Always reserve fixed space for search box area (label + bordered box + blank)
// This keeps panel size constant whether search is active or not
fixedSearchBoxLines := 3

reservedLines := headerLines + footerLines + fixedSearchBoxLines
availableHeight := effectiveHeight - reservedLines - scrollIndicatorLines
```

**Step 4: Update renderNamespaceList() line count calculation**

Location: Lines 869-884 in `internal/tui/app.go`

Update the comment to reflect Story 7.2 changes:
```go
// Calculate viewport (visible window)
// Count exact lines used by UI elements:
// - Header: "Namespaces (N)" + blank line = 2 lines
// - Each namespace item: 1 line
// - Scroll indicator (if needed): 1 line
// - Search box (Story 7.2): label + bordered box + blank = 3 lines (always reserved)
// - Footer: blank line + footer text = 2 lines

headerLines := 2
footerLines := 2
scrollIndicatorLines := 1
// Story 7.2: Fixed search box space (always reserved, whether active or not)
searchBoxLines := 3

reservedLines := headerLines + footerLines + searchBoxLines
availableHeight := effectiveHeight - reservedLines - scrollIndicatorLines
```

**Step 5: Manual testing checklist**

Test with different scenarios:
1. **Terminal size 80x24:** Activate search, verify panel doesn't shrink
2. **Many namespaces (50+):** Verify scrolling works correctly with fixed reserved space
3. **Search activation:** Press `/`, verify yellow border appears
4. **Search input:** Type "foo", verify text appears in bordered box
5. **Search cancellation:** Press ESC, verify search box disappears but panel size stays same
6. **Namespace selection:** Search "foo", select namespace, verify pods load correctly

### No Additional Research Needed

All necessary information provided:
- Existing Story 2.2 search implementation at `internal/tui/app.go:331-374`
- Viewport calculation logic at `internal/tui/app.go:601-686`
- Lip Gloss styling patterns from `internal/tui/styles/styles.go`
- Test expectations from Story 2.2 at `internal/tui/search_test.go`

Dev Agent should have complete context without reading architecture.md or PRD.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-12 | 1.0 | Initial brownfield story creation | PO (Sarah) |

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

**Expected modifications:**
- `internal/tui/styles/styles.go` - Add `SearchBoxStyle` and `SearchLabelStyle`
- `internal/tui/app.go` - Modify `renderNamespaceList()` (lines 948-952)
- `internal/tui/app.go` - Modify `adjustNamespaceViewport()` (lines 620-630)
- `internal/tui/app.go` - Update line count comments in `renderNamespaceList()` (lines 869-884)
- Potentially `internal/tui/search_test.go` - Update test expectations if needed

**No new files expected.**

## QA Results

(To be filled by QA Agent)
