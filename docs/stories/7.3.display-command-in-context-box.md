# Story 7.3: Display Command in Context Box

## Status

Draft

## Story

**As a** Kubertino user,
**I want** to see the final command that will be executed in the context box,
**so that** I understand exactly what action is being performed before it runs.

## Acceptance Criteria

1. Context box displays the final command string (after template variable substitution) alongside existing fields (context, namespace, pod, action)
2. Command display is clearly labeled (e.g., "Command:") and formatted for readability
3. Long commands are displayed without breaking the box layout
4. Existing context box styling (rounded border, cyan color, padding) remains unchanged
5. New command display follows existing pattern: left-aligned label with value
6. Integration with both `ExecuteLocal()` and `PrepareLocal()` maintains current behavior
7. Change is covered by unit tests for `renderContextBox()`
8. No regression in existing command execution functionality verified
9. Visual appearance tested manually with various command lengths

## Tasks / Subtasks

- [ ] Modify renderContextBox signature to accept command parameter (AC: 1, 5)
  - [ ] Read current implementation in `internal/executor/context_box.go` (lines 10-23)
  - [ ] Update function signature: `func renderContextBox(context, namespace, pod, action, command string) string`
  - [ ] Add command to the formatted content string using consistent formatting pattern
  - [ ] Test with various command lengths to verify layout handling

- [ ] Update call sites in executor.go to pass command string (AC: 6)
  - [ ] Read `ExecuteLocal()` method in `internal/executor/executor.go` (line 48)
  - [ ] Update call to pass computed `command` variable: `renderContextBox(context.Name, namespace, pod.Name, action.Name, command)`
  - [ ] Read `PrepareLocal()` method in `internal/executor/executor.go` (line 101)
  - [ ] Update call to pass computed `command` variable: `renderContextBox(context.Name, namespace, pod.Name, action.Name, command)`
  - [ ] Verify both methods compile and work correctly

- [ ] Handle long commands gracefully (AC: 3)
  - [ ] Determine if truncation is needed for commands longer than box width
  - [ ] Consider multi-line display or ellipsis for very long commands
  - [ ] Test with real-world command examples (kubectl exec, logs, etc.)
  - [ ] Ensure box dimensions adjust appropriately

- [ ] Add unit tests for renderContextBox (AC: 7)
  - [ ] Create test file `internal/executor/context_box_test.go` if it doesn't exist
  - [ ] Test case: Short command displays correctly
  - [ ] Test case: Long command displays without breaking layout
  - [ ] Test case: All fields (context, namespace, pod, action, command) appear in output
  - [ ] Test case: Verify Lip Gloss styling is applied

- [ ] Manual testing verification (AC: 8, 9)
  - [ ] Test with kubectl exec command (e.g., `kubectl exec -it {{.pod}} -n {{.namespace}} -- bash`)
  - [ ] Test with kubectl logs command (e.g., `kubectl logs {{.pod}} -n {{.namespace}} -f`)
  - [ ] Test with URL command (e.g., `open https://dashboard/{{.context}}/{{.namespace}}`)
  - [ ] Test with very long command to verify layout handling
  - [ ] Verify existing functionality works: actions execute correctly, terminal control works

## Dev Notes

### Story Context

This is a **brownfield enhancement** adding visibility to the action execution workflow. The change is isolated to the executor package and does not affect TUI state management, configuration, or Kubernetes integration.

**Existing System Integration:**
- Integrates with: `internal/executor` package (context box rendering and command execution)
- Technology: Go, Lip Gloss for styling, text/template for variable substitution
- Touch points:
  - `renderContextBox()` function in `context_box.go:10`
  - `ExecuteLocal()` method in `executor.go:48`
  - `PrepareLocal()` method in `executor.go:101`

### Current Implementation

**File: `internal/executor/context_box.go` (Lines 10-23)**

The context box currently displays 4 fields:
```go
content := fmt.Sprintf(
    "Context:   %s\nNamespace: %s\nPod:       %s\nAction:    %s",
    context, namespace, pod, action,
)
```

**Enhancement:** Add the final command (post-substitution) as 5th field:
```go
content := fmt.Sprintf(
    "Context:   %s\nNamespace: %s\nPod:       %s\nAction:    %s\nCommand:   %s",
    context, namespace, pod, action, command,
)
```

**File: `internal/executor/executor.go`**

Two call sites need updating:
- Line 48 in `ExecuteLocal()`: Already has `command` variable computed
- Line 101 in `PrepareLocal()`: Already has `command` variable computed

Both methods compute the final command via template substitution before calling `renderContextBox()`, so passing it is straightforward.

### Architecture Context

[Source: architecture.md]

**Command Executor Component:**

The executor uses Go's `text/template` package to substitute variables:
- `{{.context}}` - Current Kubernetes context name
- `{{.namespace}}` - Selected namespace
- `{{.pod}}` - Manually selected pod name

**Example Template Substitutions:**

| Template Command | Substituted Command (context=prod, ns=app, pod=web-123) |
|-----------------|----------------------------------------------------------|
| `kubectl logs -n {{.namespace}} {{.pod}}` | `kubectl logs -n app web-123` |
| `open https://dash/{{.context}}/{{.namespace}}` | `open https://dash/prod/app` |
| `kubectl exec -n {{.namespace}} {{.pod}} -it -- bash` | `kubectl exec -n app web-123 -it -- bash` |

This story adds visibility to show users the **final substituted command** before execution.

### Technical Notes

**Integration Approach:**
- Modify `renderContextBox()` signature to accept `command` parameter
- Update call sites in `executor.go` to pass the computed command string
- Add command to the formatted content string with consistent formatting
- Preserve existing Lip Gloss styling (rounded border, cyan color, padding)

**Existing Pattern Reference:**
- Current box format uses aligned key-value pairs with padding for alignment
- Follow same pattern for command display: `"Command:   %s"`

**Key Constraints:**
- Must handle long commands gracefully (kubectl commands can be 100+ chars)
- Preserve existing box styling and dimensions
- No changes to TUI, configuration, or Kubernetes adapter

**Risk Assessment:**
- **Primary Risk:** Very long commands might make box too wide or break layout
- **Mitigation:** Test with various command lengths; consider line wrapping if needed
- **Rollback:** Simple revert of function signature and call sites (isolated change)

### File Locations

**Files to modify:**

1. **`internal/executor/context_box.go`** (Lines 10-23)
   - Update `renderContextBox()` signature: add `command string` parameter
   - Update content formatting to include command

2. **`internal/executor/executor.go`**
   - Line 48: Update `renderContextBox()` call in `ExecuteLocal()`
   - Line 101: Update `renderContextBox()` call in `PrepareLocal()`

**Files to create:**

3. **`internal/executor/context_box_test.go`** (if doesn't exist)
   - Add unit tests for `renderContextBox()` with command parameter

### Testing

**Test Standards:**

[Source: architecture.md - Test Strategy and Standards]

**Unit Tests:**
- **Framework:** Go stdlib `testing` package
- **File Convention:** `*_test.go` alongside implementation
- **Location:** Same package as implementation (`internal/executor/context_box_test.go`)
- **Mocking Library:** `testify/mock` for interfaces (not needed for this story)
- **Coverage Requirement:** 70% minimum for `internal/` packages

**Test File:** `internal/executor/context_box_test.go`

**Required Tests:**

1. **TestRenderContextBox_ShortCommand**
   - Input: Short command (e.g., "ls -la")
   - Expected: All 5 fields displayed (context, namespace, pod, action, command)
   - Verify: Box styling applied (rounded border)

2. **TestRenderContextBox_LongCommand**
   - Input: Long kubectl command (100+ chars)
   - Expected: Command displayed without breaking box layout
   - Verify: Box dimensions remain reasonable

3. **TestRenderContextBox_AllFields**
   - Input: All parameters with realistic values
   - Expected: Each field appears in output with correct label
   - Verify: Formatting consistent with existing pattern

4. **TestRenderContextBox_TemplateSubstitution**
   - Input: Command with substituted variables (e.g., `kubectl exec -it web-123 -n app -- bash`)
   - Expected: Final substituted command displayed
   - Verify: No template variables remain in output

**Manual Testing Checklist:**

1. Launch kubertino, select namespace and pod
2. Execute action with kubectl exec command
3. Verify: Context box shows final command with all variables substituted
4. Execute action with kubectl logs command
5. Verify: Context box shows logs command correctly
6. Execute action with very long command
7. Verify: Box layout remains clean and readable
8. Execute action with URL command
9. Verify: URL displayed correctly
10. Verify: All actions still execute correctly after changes

**Coverage Target:** 80%+ for `context_box.go` (simple function, should be highly testable)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-12 | 1.0 | Initial story creation - Display command in context box | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes

_To be filled by Dev Agent during implementation_

### File List

_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after testing_
