# Story 7.6: Wait-on-Exit Flag for Fast Actions

## Status

Done

## Story

**As a** Kubertino user,
**I want** actions to optionally wait for my confirmation before returning to TUI,
**so that** I can read the output of fast-completing commands (like `kubectl describe pod`) before the screen clears.

## Context

**Существующая интеграция:**
- Компонент: `internal/executor` - выполнение actions
- Файлы: `internal/config/config.go` (Action struct), `internal/executor/context_box.go` (buildCompoundCommand)
- Технология: Go templates, shell commands via `sh -c`
- Паттерн: Compound commands (context box + actual command)

## Acceptance Criteria

1. **Add Wait-on-Exit Configuration Field:**
   - Add optional `wait_on_exit` boolean field to `Action` struct in `internal/config/config.go`
   - Default value: `false` (maintains current auto-exit behavior)
   - YAML field name: `wait_on_exit` (optional)

2. **Wait-on-Exit Behavior:**
   - When `wait_on_exit: true`, after command completes:
     - Display message: "Command finished. Press Ctrl+D to return to Kubertino."
     - Wait for user to press Ctrl+D (EOF) before returning to TUI
   - When `wait_on_exit: false` or not specified:
     - Current behavior: immediately return to TUI after command completes

3. **Implementation in Executor:**
   - Modify `buildCompoundCommand()` in `internal/executor/context_box.go`
   - If `wait_on_exit` is true, append wait logic after the command
   - Use shell mechanism: `cat` or `read` to wait for Ctrl+D
   - Show styled prompt using same color scheme as context box

4. **Example Config Update:**
   - Update `examples/kubertino.yml.example` to show `wait_on_exit` usage
   - Add example for fast commands (describe, get)
   - Add comment explaining the flag purpose

5. **Validation:**
   - No validation needed (bool field, optional)
   - Works with all action commands (kubectl, local commands, URLs)

## Tasks / Subtasks

- [x] Add `wait_on_exit` field to Action struct (AC: 1)
  - [x] Read `internal/config/config.go` (lines 19-24)
  - [x] Add `WaitOnExit bool yaml:"wait_on_exit,omitempty"` field to Action struct
  - [x] Add comment explaining the field purpose

- [x] Update executor to support wait-on-exit (AC: 2, 3)
  - [x] Read `internal/executor/context_box.go` (lines 40-50)
  - [x] Modify `buildCompoundCommand()` signature to accept `waitOnExit bool` parameter
  - [x] Create `buildWaitPrompt()` helper function:
    - Returns styled message: "Command finished. Press Ctrl+D to return to Kubertino."
    - Uses dimStyle with color matching context box
  - [x] Update compound command logic:
    - If `waitOnExit == true`: append ` && { printf '%s\n' '<wait-prompt>' && cat > /dev/null; }`
    - If `waitOnExit == false`: keep current behavior (just run command)
  - [x] Read `internal/executor/executor.go` (lines 48-49, 102-103)
  - [x] Update `ExecuteLocal()` and `PrepareLocal()` calls to `buildCompoundCommand()`:
    - Pass `action.WaitOnExit` as parameter

- [x] Update example configuration (AC: 4)
  - [x] Read `examples/kubertino.yml.example`
  - [x] Add example action with `wait_on_exit: true`:
    ```yaml
    - name: "Describe Pod"
      shortcut: "d"
      command: "kubectl describe pod {{.pod}} -n {{.namespace}}"
      wait_on_exit: true  # Wait for Ctrl+D before returning to TUI
    ```
  - [x] Add comment block explaining when to use `wait_on_exit`

- [x] Add unit tests (AC: 1-5)
  - [x] Create test in `internal/executor/context_box_test.go`:
    - `TestBuildCompoundCommand_WaitOnExit_True` - verify wait logic appended
    - `TestBuildCompoundCommand_WaitOnExit_False` - verify no wait logic
  - [x] Verify compound command contains `cat > /dev/null` when wait_on_exit=true
  - [x] Verify wait prompt message properly escaped for shell

- [x] Manual testing (All ACs)
  - [x] Test fast command with `wait_on_exit: true` (kubectl describe pod)
    - Verify command output visible
    - Verify "Press Ctrl+D" message appears
    - Verify Ctrl+D returns to TUI
  - [x] Test fast command with `wait_on_exit: false` (default)
    - Verify auto-return to TUI
  - [x] Test interactive command with `wait_on_exit: true` (kubectl exec bash)
    - Verify wait prompt appears AFTER exiting bash session
  - [x] Test with local command (open URL) with `wait_on_exit: true`
    - Verify behavior consistent

## Dev Notes

### Architecture Context

**Executor Flow (from architecture.md & Story 6.2):**

1. TUI calls `executor.PrepareLocal(action, context, namespace, pod, kubeconfigPath)`
2. Executor parses command template, substitutes variables
3. `buildCompoundCommand(contextBox, command)` creates shell command:
   - Current: `printf '%s\n\n' '<context-box>' && <command>`
4. TUI executes via `tea.ExecProcess(cmd)` - yields terminal control
5. Shell executes compound command
6. On completion, control returns to TUI

**Integration Point:** `buildCompoundCommand()` in `context_box.go`

### Current Implementation

**File:** `internal/executor/context_box.go`

```go
// buildCompoundCommand creates a shell command that displays the context box before executing the actual command.
func buildCompoundCommand(contextBox, command string) string {
    escapedBox := strings.ReplaceAll(contextBox, "'", "'\\''")
    return fmt.Sprintf("printf '%%s\\n\\n' '%s' && %s", escapedBox, command)
}
```

**Change Required:**
- Add `waitOnExit bool` parameter
- Append wait logic if true

### Proposed Solution

**Modified Signature:**
```go
func buildCompoundCommand(contextBox, command string, waitOnExit bool) string
```

**Wait Logic (Shell Pattern):**

```bash
# Original command
printf '%s\n\n' '<context-box>' && <command>

# With wait-on-exit
printf '%s\n\n' '<context-box>' && <command> && { printf '%s\n' '<wait-prompt>' && cat > /dev/null; }
```

**Why `cat > /dev/null`:**
- Waits for EOF (Ctrl+D) on stdin
- Discards any input (user might type before pressing Ctrl+D)
- Standard POSIX shell pattern
- Simple and robust

**Alternative Considered:**
- `read -p "..."` - NOT POSIX compliant (bash-specific), breaks on `sh -c`
- `cat` - Better but needs redirection to avoid accidental output

### Wait Prompt Styling

**Proposed Implementation:**

```go
func buildWaitPrompt() string {
    dimStyle := lipgloss.NewStyle().
        Foreground(lipgloss.Color("240")) // Same gray as "Press Ctrl+D to return" in context box

    return dimStyle.Render("Command finished. Press Ctrl+D to return to Kubertino.")
}
```

**Escape for Shell:**
```go
escapedPrompt := strings.ReplaceAll(buildWaitPrompt(), "'", "'\\''")
```

### File Locations

**Files to modify:**

1. **`internal/config/config.go`** (Line 19-24)
   - Add `WaitOnExit bool` field after `Destructive bool`

2. **`internal/executor/context_box.go`** (Lines 40-50)
   - Modify `buildCompoundCommand()` signature
   - Add `buildWaitPrompt()` function
   - Implement conditional wait logic

3. **`internal/executor/executor.go`** (Lines 48-49, 102-103)
   - Update calls to `buildCompoundCommand()` in `ExecuteLocal()`
   - Update calls to `buildCompoundCommand()` in `PrepareLocal()`
   - Pass `action.WaitOnExit` parameter

4. **`examples/kubertino.yml.example`**
   - Add example action with `wait_on_exit: true`

**Files to create:**

5. **`internal/executor/context_box_test.go`**
   - Unit tests for wait-on-exit logic

### Risk Assessment

**Primary Risk:** Shell escaping issues with wait prompt
- **Mitigation:** Use same escaping pattern as context box (proven safe)
- **Test:** Include special characters in wait prompt tests

**Secondary Risk:** Wait mechanism hangs terminal
- **Mitigation:** `cat > /dev/null` is standard POSIX pattern, well-tested
- **Rollback:** Remove wait logic, revert to current behavior

**Compatibility:**
- ✅ No breaking changes (new optional field)
- ✅ Default behavior unchanged (wait_on_exit defaults to false)
- ✅ Works with all action types (kubectl, local, URL)

### Testing

**Unit Tests:**

**Test File:** `internal/executor/context_box_test.go`

1. **TestBuildCompoundCommand_WaitOnExit_False**
   - Input: `waitOnExit = false`
   - Expected: Command WITHOUT wait logic
   - Verify: String does NOT contain `cat > /dev/null`

2. **TestBuildCompoundCommand_WaitOnExit_True**
   - Input: `waitOnExit = true`
   - Expected: Command WITH wait logic appended
   - Verify: String contains `&& { printf ... && cat > /dev/null; }`

3. **TestBuildWaitPrompt**
   - Verify: Returns non-empty styled string
   - Verify: Contains "Press Ctrl+D"

4. **TestWaitPromptShellEscaping**
   - Verify: Single quotes properly escaped in wait prompt
   - Input: Prompt with special characters
   - Expected: Properly escaped for shell safety

**Manual Test Checklist:**

1. Configure action with `wait_on_exit: true`:
   ```yaml
   - name: "Describe Pod"
     shortcut: "d"
     command: "kubectl describe pod {{.pod}} -n {{.namespace}}"
     wait_on_exit: true
   ```

2. Execute action in Kubertino:
   - Verify context box appears
   - Verify command output displays
   - Verify "Command finished. Press Ctrl+D..." appears
   - Press Ctrl+D → Verify return to TUI

3. Test with `wait_on_exit: false` (or omitted):
   - Verify immediate return to TUI after command completes

4. Test interactive command with `wait_on_exit: true`:
   ```yaml
   - name: "Bash"
     shortcut: "b"
     command: "kubectl exec -it {{.pod}} -n {{.namespace}} -- /bin/bash"
     wait_on_exit: true
   ```
   - Exit bash session
   - Verify wait prompt appears AFTER bash exits
   - Press Ctrl+D → Return to TUI

**Coverage Requirement:** 70%+ for `context_box.go`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-18 | 1.0 | Initial - wait-on-exit flag for actions | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None

### Completion Notes

- Successfully implemented `wait_on_exit` flag for actions
- Added `WaitOnExit` boolean field to Action struct in internal/config/config.go:24
- Created `buildWaitPrompt()` helper function in internal/executor/context_box.go:40-46
- Modified `buildCompoundCommand()` to accept `waitOnExit` parameter and conditionally append wait logic using `cat > /dev/null` pattern in internal/executor/context_box.go:52-68
- Updated both `ExecuteLocal()` and `PrepareLocal()` in internal/executor/executor.go:49,103 to pass `action.WaitOnExit` parameter
- Added example with `wait_on_exit: true` to examples/kubertino.yml.example:24
- Added comprehensive documentation explaining when to use the flag in examples/kubertino.yml.example:97-101
- Created 5 new unit tests covering wait-on-exit functionality and shell escaping in internal/executor/context_box_test.go:195-301
- All tests passing (100% of new code tested)
- Linting clean (0 issues)
- No breaking changes - fully backward compatible with default value `false`

### File List

**Modified:**
- internal/config/config.go
- internal/executor/context_box.go
- internal/executor/executor.go
- internal/executor/context_box_test.go
- examples/kubertino.yml.example

---

## QA Results

### Review Date: 2025-10-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of the wait-on-exit feature. The code is clean, well-structured, and follows Go best practices. The developer demonstrated strong understanding of shell scripting and POSIX compliance by using `cat > /dev/null` for the wait mechanism. Shell escaping is properly handled throughout using the '\'' pattern. The implementation maintains backward compatibility with a sensible default (false) and integrates seamlessly with the existing executor architecture.

Key strengths:
- Consistent use of color constants (colorGray) for styling
- Proper separation of concerns (buildWaitPrompt helper function)
- Clear, self-documenting code with helpful comments
- Zero technical debt introduced

### Refactoring Performed

No refactoring was necessary. The implementation is production-ready as-is.

### Compliance Check

- Coding Standards: ✓ (No standards document found, but code follows Go best practices)
- Project Structure: ✓ (Changes fit cleanly into existing executor package structure)
- Testing Strategy: ✓ (No strategy document found, but 87.5% coverage exceeds typical standards)
- All ACs Met: ✓ (All 5 acceptance criteria fully implemented and tested)

### Improvements Checklist

All improvements completed by developer - no additional work required:

- [x] Wait-on-exit flag properly implemented in config struct
- [x] Shell-safe wait mechanism using POSIX-compliant `cat > /dev/null`
- [x] Styled prompt message with consistent color scheme
- [x] Comprehensive test coverage (87.5%) with 5 dedicated tests
- [x] Example configuration updated with clear documentation
- [x] Backward compatibility maintained (default: false)

### Security Review

✓ PASS - No security concerns identified.

Shell injection protection is properly implemented using the same escaping pattern as the existing context box feature (POSIX '\'' escaping). The wait prompt text is hardcoded (no user input), eliminating any injection risk. The `cat > /dev/null` pattern safely discards stdin without exposing data.

### Performance Considerations

✓ PASS - No performance impact.

The wait logic only executes when `wait_on_exit: true`, making it opt-in with zero overhead for existing actions. The `cat > /dev/null` command is lightweight and standard, adding negligible latency.

### Files Modified During Review

None - no modifications were necessary during QA review.

### Gate Status

Gate: **PASS** → docs/qa/gates/7.6-wait-on-exit-for-actions.yml

### Recommended Status

✓ **Ready for Done**

This story is production-ready with no blockers or concerns. All acceptance criteria are met, tests are comprehensive and passing, and the implementation is clean with zero technical debt.
