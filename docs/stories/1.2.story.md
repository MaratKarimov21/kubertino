# Story 1.2: Configuration File Parser

## Status

Done

## Story

**As a** user,
**I want** the tool to read and parse ~/.kubertino.yml configuration,
**so that** I can customize contexts, namespaces, and actions.

## Acceptance Criteria

1. YAML configuration file loaded from ~/.kubertino.yml
2. Configuration structure includes: contexts, default_pod_pattern, favorite_namespaces, actions
3. Each context includes: name, kubeconfig path, namespace favorites, actions array
4. Actions include: name, shortcut, type (pod_exec/url/local), command/url template
5. Configuration validation on load with specific error messages
6. Example configuration file provided in repository
7. Unit tests cover valid and invalid configuration scenarios
8. Shortcut conflicts detected and reported

## Tasks / Subtasks

- [x] Implement YAML configuration parsing (AC: 1, 2, 3, 4)
  - [x] Create Config, Context, and Action structs in `internal/config/config.go` matching data model specifications
  - [x] Implement Parse function in `internal/config/parser.go` using gopkg.in/yaml.v3
  - [x] Implement file loading from ~/.kubertino.yml path with proper error handling
  - [x] Parse Config structure with Version and Contexts array
  - [x] Parse Context structure with Name, Kubeconfig, ClusterURL, DefaultPodPattern, FavoriteNamespaces, Actions
  - [x] Parse Action structure with Name, Shortcut, Type, Command, URL, PodPattern

- [x] Implement configuration validation (AC: 5, 8)
  - [x] Create Validate function in `internal/config/validator.go`
  - [x] Validate required fields are present (Name, DefaultPodPattern for Context; Name, Shortcut, Type for Action)
  - [x] Validate regex patterns compile correctly (DefaultPodPattern, PodPattern)
  - [x] Detect and report duplicate shortcuts within each context
  - [x] Validate action types are one of: pod_exec, url, local
  - [x] Validate pod_exec actions have Command field
  - [x] Validate url actions have URL field
  - [x] Prevent command injection by checking for unsafe characters (;|&) in Command templates
  - [x] Return errors with line numbers from YAML where possible

- [x] Create example configuration file (AC: 6)
  - [x] Create `examples/kubertino.yml.example` with sample configuration
  - [x] Include example context with multiple actions demonstrating pod_exec, url, and local types
  - [x] Include comments explaining each configuration option
  - [x] Include examples of favorite_namespaces and default_pod_pattern

- [x] Implement unit tests (AC: 7)
  - [x] Create test fixtures in `internal/testdata/` directory
  - [x] Create `valid-config.yml` fixture with correct configuration
  - [x] Create `invalid-config.yml` fixtures for various error cases
  - [x] Write table-driven tests in `internal/config/config_test.go` for valid configuration parsing
  - [x] Write table-driven tests in `internal/config/validator_test.go` for:
    - Valid configuration passes validation
    - Missing required fields detected
    - Invalid regex patterns detected
    - Duplicate shortcuts detected
    - Invalid action types detected
    - Command injection characters detected
    - Missing command/url fields for action types
  - [x] Achieve 70%+ test coverage for config package
  - [x] Create test helper factories (e.g., NewTestConfig, NewTestContext)

## Dev Notes

### Data Models
[Source: architecture.md#Data Models - Configuration Model]

The configuration system uses three main Go structs that must be implemented in `internal/config/config.go`:

```go
type Config struct {
    Version  string    `yaml:"version"`
    Contexts []Context `yaml:"contexts"`
}

type Context struct {
    Name               string   `yaml:"name"`
    Kubeconfig         string   `yaml:"kubeconfig"`
    ClusterURL         string   `yaml:"cluster_url,omitempty"`
    DefaultPodPattern  string   `yaml:"default_pod_pattern"`
    FavoriteNamespaces []string `yaml:"favorite_namespaces"`
    Actions            []Action `yaml:"actions"`
}

type Action struct {
    Name       string `yaml:"name"`
    Shortcut   string `yaml:"shortcut"`
    Type       string `yaml:"type"` // pod_exec, url, local
    Command    string `yaml:"command,omitempty"`
    URL        string `yaml:"url,omitempty"`
    PodPattern string `yaml:"pod_pattern,omitempty"`
}
```

### Technology Stack
[Source: architecture.md#Tech Stack]

- **YAML Parser**: gopkg.in/yaml.v3 version 3.0+
- **Language**: Go 1.21+
- **Testing**: Go stdlib testing package with github.com/stretchr/testify for assertions

### File Locations
[Source: architecture.md#Source Tree]

- Config structures: `internal/config/config.go`
- YAML parsing logic: `internal/config/parser.go`
- Validation logic: `internal/config/validator.go`
- Example config: `examples/kubertino.yml.example`
- Test fixtures: `internal/testdata/valid-config.yml`, `internal/testdata/invalid-config.yml`
- Unit tests: `internal/config/config_test.go`, `internal/config/validator_test.go`

### Configuration Manager Requirements
[Source: architecture.md#Configuration Manager]

The Configuration Manager component has these responsibilities:
- YAML parsing
- Configuration validation
- Future hot-reload support (not in this story)

Key interfaces to implement:
- `Parse(filename string) (*Config, error)` - Parse YAML file
- `Validate(*Config) error` - Validate configuration rules

Implementation notes:
- Validation rules: unique shortcuts per context, valid regex patterns, required fields
- Error messages should include line numbers from YAML where possible
- Cache parsed regex patterns for performance (optimization for future stories)

### Validation Rules
[Source: architecture.md#Security - Input Validation]

Critical validation rules that must be implemented:

1. **Required Fields**: Ensure all required struct fields are populated
2. **Unique Shortcuts**: Each context must have unique action shortcuts (no duplicates)
3. **Valid Regex**: DefaultPodPattern and PodPattern fields must be valid Go regex
4. **Action Type Validation**: Type must be one of: pod_exec, url, local
5. **Command Injection Prevention**: Prevent unsafe characters in command templates (check for: ; | &)
6. **Field Requirements by Action Type**:
   - pod_exec actions require Command field
   - url actions require URL field

Example validation error structure:
```go
func ValidateAction(a *Action) error {
    if a.Shortcut == "" || len(a.Shortcut) > 1 {
        return fmt.Errorf("shortcut must be single character")
    }
    if a.Type == "" {
        return fmt.Errorf("action type required")
    }
    if strings.ContainsAny(a.Command, ";|&") {
        return fmt.Errorf("command contains unsafe characters")
    }
    return nil
}
```

### Error Handling Patterns
[Source: architecture.md#Error Handling Strategy]

Configuration errors should provide clear, user-facing messages with fix suggestions:

```go
if err := config.Validate(); err != nil {
    return fmt.Errorf("configuration validation failed: %w\n\nCheck ~/.kubertino.yml:\n%s",
        err, err.Hints())
}
```

Use wrapped errors with context at each layer using `fmt.Errorf("context: %w", err)` pattern.

### Naming Conventions
[Source: architecture.md#Coding Standards - Naming Conventions]

- Packages: lowercase, single word (e.g., `config`)
- Files: lowercase with underscores (e.g., `config_test.go`)
- Types: PascalCase (e.g., `Config`, `Context`, `Action`)
- Functions: PascalCase for exported (e.g., `Parse`, `Validate`), camelCase for private (e.g., `parseYAML`)
- Interfaces: PascalCase with -er suffix where appropriate

### Testing

[Source: architecture.md#Test Strategy - Unit Tests]

**Test Organization:**
- Test files next to implementation: `internal/config/config_test.go`
- Use table-driven test pattern
- Place test fixtures in `internal/testdata/` directory

**Coverage Requirement:** 70%+ for config package

**Test Framework:**
- Go stdlib `testing` package
- `github.com/stretchr/testify` for assertions and mocks

**Required Test Scenarios:**

1. **Valid Configuration Tests:**
   - Successfully parse valid YAML
   - All fields populated correctly
   - Multiple contexts handled
   - All action types parsed

2. **Invalid Configuration Tests:**
   - Duplicate shortcuts within context
   - Missing required fields
   - Invalid regex patterns
   - Invalid action types
   - Command injection characters present
   - Missing command/url for action types

**Example Table-Driven Test Structure:**
[Source: architecture.md#Test Strategy - Unit Tests]

```go
func TestConfigValidation(t *testing.T) {
    tests := []struct {
        name    string
        config  *Config
        wantErr bool
    }{
        {
            name: "valid config",
            config: &Config{
                Version: "1.0",
                Contexts: []Context{{Name: "test", DefaultPodPattern: ".*"}},
            },
            wantErr: false,
        },
        {
            name: "duplicate shortcuts",
            config: &Config{
                Contexts: []Context{{
                    Actions: []Action{
                        {Shortcut: "c", Name: "console"},
                        {Shortcut: "c", Name: "bash"},
                    },
                }},
            },
            wantErr: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := ValidateConfig(tt.config)
            if (err != nil) != tt.wantErr {
                t.Errorf("ValidateConfig() error = %v, wantErr %v", err, tt.wantErr)
            }
        })
    }
}
```

**Test Data Management:**
[Source: architecture.md#Test Data Management]

Create test helper factories for creating test data:

```go
func NewTestConfig() *Config {
    return &Config{
        Version: "1.0",
        Contexts: []Context{
            NewTestContext("test-context"),
        },
    }
}
```

**Test Fixtures Location:** `internal/testdata/`
- `valid-config.yml` - Valid configuration example
- `invalid-config.yml` - Various invalid configurations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Story created | Scrum Master |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None

### Completion Notes List

- Successfully implemented all configuration parsing functionality using gopkg.in/yaml.v3
- Implemented comprehensive validation with clear error messages including context information
- Created detailed example configuration file with comments explaining all options
- Achieved 98.2% test coverage, exceeding the 70% requirement
- All tests pass and code passes linting with golangci-lint
- Implemented test helper factories for easier test data creation
- Created 6 test fixture files covering valid and various invalid scenarios

### File List

**Source Files:**
- `internal/config/config.go` - Config, Context, and Action struct definitions
- `internal/config/parser.go` - YAML parsing with tilde expansion support
- `internal/config/validator.go` - Comprehensive validation with error messages

**Test Files:**
- `internal/config/config_test.go` - Parser tests with 98.2% coverage
- `internal/config/validator_test.go` - Validation tests covering all error cases

**Test Fixtures:**
- `internal/testdata/valid-config.yml` - Valid configuration example
- `internal/testdata/invalid-missing-name.yml` - Missing required name field
- `internal/testdata/invalid-duplicate-shortcuts.yml` - Duplicate shortcut detection
- `internal/testdata/invalid-regex.yml` - Invalid regex pattern
- `internal/testdata/invalid-action-type.yml` - Invalid action type
- `internal/testdata/invalid-command-injection.yml` - Command injection detection
- `internal/testdata/invalid-yaml.yml` - Malformed YAML

**Example Files:**
- `examples/kubertino.yml.example` - Comprehensive example configuration with comments

**Modified Files:**
- `go.mod` - Added gopkg.in/yaml.v3 v3.0.1 and github.com/stretchr/testify v1.11.1
- `go.sum` - Updated with new dependencies

## QA Results

### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Quality: Excellent**

The implementation demonstrates high-quality professional Go code with comprehensive testing, proper error handling, and strong security considerations. The code follows Go idioms and architectural guidelines precisely. Test coverage of 98.2% significantly exceeds the 70% requirement, with both unit tests and fixture-based integration tests.

**Strengths:**
- Clean separation of concerns (config structs, parser, validator)
- Comprehensive validation with clear, actionable error messages
- Security-first approach with command injection prevention
- Excellent test coverage using table-driven tests
- Proper use of Go error wrapping with context
- Test helper factories for maintainability

### Refactoring Performed

- **File**: `internal/config/parser.go:14`
  - **Change**: Added length check before slicing filename for tilde expansion
  - **Why**: Prevented potential index out of bounds panic if filename is shorter than 2 characters
  - **How**: Changed `if filename[:2] == "~/"` to `if len(filename) >= 2 && filename[:2] == "~/"`
  - **Impact**: Defensive programming - prevents edge case runtime panic

### Compliance Check

- Coding Standards: ✓ **Pass** - Follows all Go naming conventions, gofmt applied, golangci-lint clean
- Project Structure: ✓ **Pass** - Files placed correctly per architecture.md source tree specification
- Testing Strategy: ✓ **Pass** - Exceeds 70% coverage requirement with 98.2%, uses table-driven tests
- All ACs Met: ✓ **Pass** - All 8 acceptance criteria fully implemented and validated

### Requirements Traceability

**AC1: YAML configuration file loaded from ~/.kubertino.yml**
- **Implemented**: `internal/config/parser.go:12-35` - Parse() function with tilde expansion
- **Tests**: `config_test.go:12-116` - TestParse and TestParse_TildeExpansion
- **Status**: ✓ Covered

**AC2: Configuration structure includes contexts, default_pod_pattern, favorite_namespaces, actions**
- **Implemented**: `internal/config/config.go:4-27` - Config, Context, Action structs with yaml tags
- **Tests**: `config_test.go:24-55` - Validates all struct fields parse correctly
- **Status**: ✓ Covered

**AC3: Each context includes name, kubeconfig path, namespace favorites, actions array**
- **Implemented**: `internal/config/config.go:10-17` - Context struct definition
- **Tests**: `config_test.go:28-34` - Validates Context fields
- **Status**: ✓ Covered

**AC4: Actions include name, shortcut, type, command/url template**
- **Implemented**: `internal/config/config.go:20-27` - Action struct definition
- **Tests**: `config_test.go:36-55` - Validates all Action types (pod_exec, url, local)
- **Status**: ✓ Covered

**AC5: Configuration validation on load with specific error messages**
- **Implemented**: `internal/config/validator.go:9-121` - Comprehensive validation with contextual errors
- **Tests**: `validator_test.go:10-365` - 18 validation test cases
- **Status**: ✓ Covered

**AC6: Example configuration file provided**
- **Implemented**: `examples/kubertino.yml.example` - Comprehensive example with comments
- **Tests**: Manual verification of example file structure
- **Status**: ✓ Covered

**AC7: Unit tests cover valid and invalid configuration scenarios**
- **Implemented**: `config_test.go`, `validator_test.go` - 24 total test cases
- **Coverage**: 98.2% statement coverage
- **Status**: ✓ Covered

**AC8: Shortcut conflicts detected and reported**
- **Implemented**: `validator.go:45-57` - Duplicate shortcut detection per context
- **Tests**: `validator_test.go:82-98, 322-327` - Explicit duplicate shortcut tests
- **Status**: ✓ Covered

### Improvements Checklist

**Completed During Review:**
- [x] Fixed index out of bounds vulnerability in tilde expansion (parser.go:14)
- [x] Verified all error messages include helpful context
- [x] Validated security measures against command injection
- [x] Confirmed test coverage exceeds requirements

**Future Enhancements (Not Blocking):**
- [ ] Consider adding URL format validation for url-type actions
- [ ] Consider max length validation for command fields
- [ ] Consider caching compiled regex patterns for performance (noted in architecture)

### Security Review

**Status: ✓ Pass**

Security measures properly implemented:
1. **Command Injection Prevention** - Characters `;|&` blocked in command templates (validator.go:101-104)
2. **Input Validation** - All required fields validated before use
3. **Regex Validation** - Patterns compiled during validation to prevent malformed regex
4. **Path Handling** - Tilde expansion properly implemented with error handling
5. **Type Safety** - Action types restricted to allowed values (pod_exec, url, local)

**Tests Validate Security:**
- Command injection tests: `validator_test.go:219-268` (semicolon, pipe, ampersand)
- Invalid regex tests: `validator_test.go:71-80, 270-285`

### Performance Considerations

**Status: ✓ Pass**

- Configuration parsing uses efficient yaml.v3 library
- Validation occurs once at load time
- Regex patterns validated but not cached (acceptable for config-load-once pattern)
- No performance bottlenecks identified
- File I/O properly error-handled with os.ReadFile

### Files Modified During Review

**Modified:**
- `internal/config/parser.go` - Fixed index bounds check (line 14)

**Created:**
- `docs/qa/gates/1.2-configuration-file-parser.yml` - Quality gate decision

### Gate Status

Gate: **PASS** → `docs/qa/gates/1.2-configuration-file-parser.yml`

### Recommended Status

✓ **Ready for Done**

All acceptance criteria met, tests passing, security validated, code quality excellent. The single refactoring performed was a defensive programming improvement that prevents edge case panics. No blocking issues identified.