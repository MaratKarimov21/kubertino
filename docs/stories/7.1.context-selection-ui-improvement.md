# Story 7.1: Context Selection UI Improvement - Brownfield Enhancement

## Status

Done

## Story

**As a** Kubertino user,
**I want** a visually appealing context selection dialog with a border frame (not full-screen),
**so that** the context selection experience is more polished and consistent with the action execution context box design.

## Story Context

### Existing System Integration

- **Integrates with:** Context selection flow in `internal/tui/app.go` (Story 2.1)
- **Technology:** Bubble Tea TUI framework, Lip Gloss styling library
- **Follows pattern:** Context box rendering pattern from `internal/executor/context_box.go`
- **Touch points:**
  - `renderContextList()` method in `internal/tui/app.go` (lines 995-1029)
  - View mode state machine (viewModeContextSelection)
  - Existing Lip Gloss border styles in `internal/tui/styles/styles.go`

### Current Implementation Analysis

**Current behavior (Story 2.1):**
- Context selection uses full-screen layout
- Simple text-based list with "> " prefix for selection
- Basic header "Select Kubernetes Context" with footer hints
- No visual borders or framing

**Reference design (executor context box):**
- Uses `lipgloss.RoundedBorder()` with cyan color (`lipgloss.Color("39")`)
- Padding: `Padding(1, 2)` for comfortable spacing
- Bold text for emphasis
- Compact, centered presentation

## Acceptance Criteria

### Functional Requirements

1. Context selection displays in a centered bordered dialog (not full-screen)
2. Dialog uses rounded border with padding (similar to executor context box)
3. Context list shows all available contexts with selection indicator
4. Arrow keys navigate through contexts (existing behavior preserved)
5. Enter key confirms selection and transitions to namespace view (existing behavior preserved)

### Integration Requirements

6. Existing context selection keyboard navigation continues to work unchanged (Up/Down/Enter/ESC/q)
7. Integration with namespace view maintains current behavior (seamless transition on Enter)
8. All existing Story 2.1 functionality remains intact (auto-selection for single context, etc.)

### Quality Requirements

9. Visual design follows `renderContextBox()` pattern (rounded border, cyan color, padding)
10. Dialog is centered on screen regardless of terminal size
11. No regression in existing context selection tests (`internal/tui/app_test.go`)

## Technical Notes

### Integration Approach

This enhancement modifies only the **visual presentation** of the context selection screen. The underlying logic (navigation, selection, state management) remains unchanged from Story 2.1.

**Key changes:**
- Modify `renderContextList()` in `internal/tui/app.go` to use bordered box layout
- Apply Lip Gloss border and centering styles
- Ensure responsive behavior for different terminal sizes

### Existing Pattern Reference

**Executor context box style (from `internal/executor/context_box.go:10-23`):**
```go
boxStyle := lipgloss.NewStyle().
    Border(lipgloss.RoundedBorder()).
    BorderForeground(lipgloss.Color("39")). // Bright cyan
    Padding(1, 2).
    Bold(true)
```

**Apply similar styling to context list:**
- Use `lipgloss.RoundedBorder()` for visual consistency
- Apply cyan border color `lipgloss.Color("39")`
- Center the dialog using `lipgloss.Place()` with `lipgloss.Center, lipgloss.Center`
- Calculate dialog dimensions based on content (context list length + header + footer)

### Key Constraints

- **Backward compatibility:** All Story 2.1 tests must pass without modification
- **Terminal size handling:** Dialog must gracefully handle small terminals (respect `MinTerminalWidth`, `MinTerminalHeight`)
- **Existing styles:** Reuse `SelectedStyle`, `NormalStyle`, `DimStyle` from `internal/tui/styles/styles.go`

## Definition of Done

- [x] Functional requirements met
- [x] Context selection renders in centered bordered dialog (not full-screen)
- [x] Dialog uses rounded border with cyan color and padding
- [x] All keyboard navigation works (up/down/enter/esc/q)
- [x] Auto-selection for single context still works
- [x] Integration requirements verified
- [x] Existing functionality regression tested (Story 2.1 behavior preserved)
- [x] Namespace view transition works seamlessly
- [x] Code follows existing patterns and standards
- [x] Tests pass (existing Story 2.1 tests + any new visual tests)
- [x] No breaking changes to `AppModel` or Update() logic

## Risk Assessment

### Primary Risk
Breaking existing context selection functionality or tests from Story 2.1.

### Mitigation
- Make only visual changes to `renderContextList()`
- Do not modify AppModel state fields or Update() logic
- Run full test suite (`internal/tui/app_test.go`) to verify no regressions
- Test manually with 1 context (auto-select) and multiple contexts (selection dialog)

### Rollback
Simple rollback to previous `renderContextList()` implementation if issues arise. No database or config changes involved.

## Compatibility Verification

- [x] No breaking changes to existing APIs (only internal rendering method modified)
- [x] No database changes needed
- [x] UI changes follow existing design patterns (context box style)
- [x] Performance impact is negligible (same number of contexts rendered, just styled differently)

## Dev Notes

### Relevant Source Tree

Based on architecture.md#Source Tree and Story 2.1:
- **Main file to modify:** `internal/tui/app.go` (lines 995-1029: `renderContextList()`)
- **Styles reference:** `internal/tui/styles/styles.go` (existing border styles)
- **Pattern reference:** `internal/executor/context_box.go:10-23` (border style example)
- **Tests location:** `internal/tui/app_test.go` (Story 2.1 context selection tests)

### Implementation Approach

**Step 1: Modify `renderContextList()` method**

Current rendering (Story 2.1):
```go
func (m AppModel) renderContextList() string {
    var s string
    header := styles.TitleStyle.Render("Select Kubernetes Context")
    s += header + "\n\n"

    // Context list
    for i, ctx := range m.contexts {
        prefix := "  "
        if i == m.selectedContextIndex {
            prefix = "> "
        }
        // ... render contexts
    }

    s += "\n"
    footer := styles.DimStyle.Render("↑/↓ Navigate | Enter: Select | ESC/q: Quit")
    s += footer
    return s
}
```

**New rendering (with bordered dialog):**
```go
func (m AppModel) renderContextList() string {
    // Build inner content (header + contexts + footer)
    var content string

    // Header
    header := styles.TitleStyle.Render("Select Kubernetes Context")
    content += header + "\n\n"

    // Context list (same logic as before)
    for i, ctx := range m.contexts {
        prefix := "  "
        if i == m.selectedContextIndex {
            prefix = "> "
        }

        // Render context line with appropriate styling (same as before)
        if i == m.selectedContextIndex {
            content += styles.SelectedStyle.Render(prefix+ctx.Name) + "\n"
        } else {
            content += styles.NormalStyle.Render(prefix+ctx.Name) + "\n"
        }
    }

    // Footer
    content += "\n"
    footer := styles.DimStyle.Render("↑/↓ Navigate | Enter: Select | ESC/q: Quit")
    content += footer

    // Apply border style (similar to context box)
    dialogStyle := lipgloss.NewStyle().
        Border(lipgloss.RoundedBorder()).
        BorderForeground(lipgloss.Color("39")). // Bright cyan
        Padding(1, 2).
        Bold(false) // Don't make all text bold, just use existing styles

    styledDialog := dialogStyle.Render(content)

    // Center the dialog on screen
    return lipgloss.Place(
        m.termWidth,
        m.termHeight,
        lipgloss.Center,
        lipgloss.Center,
        styledDialog,
    )
}
```

**Step 2: Test with existing tests**
- Run `go test ./internal/tui/...` to ensure no regressions
- Existing tests check content, not exact layout, so they should pass
- If tests fail due to border characters, update test expectations minimally

**Step 3: Manual testing**
- Test with 1 context (should auto-select, dialog not shown)
- Test with 3+ contexts (should show centered bordered dialog)
- Test on small terminal (80x24) and large terminal
- Verify keyboard navigation works (up/down/enter/esc/q)

### Testing Standards

From architecture.md#Test Strategy:
- **Test file location:** `internal/tui/app_test.go` (co-located with app.go)
- **Framework:** Go stdlib `testing` package with `testify/assert`
- **Coverage requirement:** Maintain existing 100% coverage from Story 2.1
- **Style:** Table-driven tests

**No new tests needed** if existing tests pass (visual change only). If tests fail:
1. Update test expectations to match new bordered layout
2. Ensure test logic checks for content presence, not exact string match

### Important Constraints

**From architecture.md#Coding Standards:**
- Use `gofmt` for formatting
- Follow existing naming conventions (camelCase for private methods)
- Do not introduce global mutable state
- Maintain 70%+ test coverage (currently 100% from Story 2.1)

**Performance considerations:**
- No additional kubectl calls or data fetching
- Same number of contexts rendered, just styled differently
- Lip Gloss rendering is efficient and negligible overhead

### No Additional Research Needed

All necessary information provided:
- Existing Story 2.1 implementation at `internal/tui/app.go:995-1029`
- Context box pattern reference at `internal/executor/context_box.go:10-23`
- Lip Gloss border styles documented in architecture.md#Tech Stack
- Test expectations from Story 2.1 at `internal/tui/app_test.go`

Dev Agent should NOT need to read architecture.md or PRD. This is a focused visual enhancement.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-12 | 1.0 | Initial brownfield story creation | PO (Sarah) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - No issues encountered during implementation

### Completion Notes List

- Modified `renderContextList()` in `internal/tui/app.go` (lines 1103-1152) to use bordered dialog with centering
- Applied rounded border with cyan color (`lipgloss.Color("39")`) and padding (1, 2) matching executor context box pattern
- Used `lipgloss.Place()` to center dialog on screen with `m.termWidth` and `m.termHeight`
- All existing keyboard navigation preserved (up/down/enter/esc/q)
- Full test suite passes with no regressions (80 tests, 0 failures)
- Build succeeds with no compilation errors
- No changes to AppModel state or Update() logic - only visual rendering modified

### File List

**Modified files:**
- `internal/tui/app.go` - Modified `renderContextList()` method to use bordered, centered dialog (lines 1103-1152)

**No new files created.**

## QA Results

(To be filled by QA Agent)
