# Issue: Panel Height Still Not Fixed After 4 Iterations

## Status
**OPEN** - Blocking Story 7.2 completion

## Severity
**HIGH** - Critical UX issue affecting user experience

## Reporter
User (via Quinn QA Agent)

## Date Reported
2025-10-13

## Problem Description

Despite 4 iterations of fixes, the namespace panel height is still not remaining constant when activating/deactivating search mode.

**User Feedback (Russian):**
> "Все еще высота неправильная - сначала маленькая а при поиске слишком большая"

**Translation:**
> "Height still wrong - first small, then too large during search"

## Expected Behavior

1. Panel height should remain **exactly the same** whether search mode is active or not
2. When pressing `/` to activate search, panel should NOT grow or shrink
3. When pressing `ESC` to deactivate search, panel should NOT grow or shrink
4. Search box should always be anchored to the bottom of the panel

## Actual Behavior

Panel height changes when toggling search mode:
- **Without search**: Panel appears smaller
- **With search active**: Panel appears larger

This indicates that despite our fixes, the panel sizing logic is still not truly fixed.

## History of Fix Attempts

### Iteration 1 (Initial Implementation)
- Added `.Height(contentHeight)` to renderNamespacePanel
- Added width calculation for search box
- **Result**: Panel didn't reach full height, search box too narrow

### Iteration 2 (QA Fix)
- Changed panel height to `Height(height - 4)` using incoming height parameter
- Reduced search box width to 70% with bounds (20-50 chars)
- **Result**: Panel height still varying, search box better sized

### Iteration 3 (QA Fix)
- Added dynamic padding calculation to anchor search box to bottom
- Code: `searchAndFooterLines = 2` when search off, `5` when search on
- **Result**: Search box anchored, but panel height still changes (3-line difference)

### Iteration 4 (QA Fix - Current)
- Changed to fixed padding: `searchAndFooterLines := 2 + 3` (ALWAYS)
- Matched `fixedSearchBoxLines = 3` from viewport calculation
- **Result**: User reports NO improvement - problem persists

## Root Cause Analysis

The issue persists after 4 iterations, suggesting the problem is **NOT** in the padding calculation but somewhere else in the rendering chain. Possible causes:

### Hypothesis 1: Lip Gloss Height() Behavior
The `Height()` method on border styles may not work as expected:
```go
// Line 1243 in app.go
return borderStyle.
    Width(contentWidth).
    Height(height - 4).  // ← This may not enforce fixed height
    Render(content)
```

**Evidence**: In Iteration 2, we tried using `Height()` to force the panel to fill allocated space, but Lip Gloss may not actually pad content to fill the height when content is shorter.

### Hypothesis 2: Content String Length Variation
The content string `s` in `renderNamespaceList()` may have different **actual line counts** in search vs non-search mode, even with padding:

```go
// When search mode OFF: content has fewer lines
// When search mode ON: content has search box (3 lines) + padding adjusts

// But the TOTAL string may still be different lengths
```

### Hypothesis 3: Border/Padding Rendering Issue
Lip Gloss may be recalculating the actual rendered height based on content, ignoring the `.Height()` directive when content doesn't fill the space.

### Hypothesis 4: Search Box Rendering Location
The search box is rendered INSIDE the content string in `renderNamespaceList()`, but the panel height calculation happens in `renderNamespacePanel()`. There may be a mismatch between:
- What `renderNamespacePanel` THINKS the content height is
- What `renderNamespaceList` ACTUALLY produces

## Technical Details

### Current Implementation

**File: `internal/tui/app.go`**

**renderNamespacePanel** (lines 1202-1233):
```go
func (m AppModel) renderNamespacePanel(width, height int) string {
    contentHeight := height - 4 // Subtract border (2) + padding (2)

    content := m.renderNamespaceList(contentHeight)

    contentWidth := width - 6

    borderStyle := styles.UnfocusedPanelBorderStyle
    if m.focusedPanel == PanelNamespaces {
        borderStyle = styles.FocusedPanelBorderStyle
    }

    return borderStyle.
        Width(contentWidth).
        Height(height - 4).  // ← Issue may be here
        Render(content)
}
```

**renderNamespaceList** (lines 956-1116):
```go
func (m AppModel) renderNamespaceList(panelHeight int) string {
    // ... namespace rendering ...

    // Story 7.2 QA Fix #3 (Iteration 4): Add padding
    searchAndFooterLines := 2 + 3 // ALWAYS FIXED
    paddingLines := effectiveHeight - linesUsed - searchAndFooterLines

    // Add padding
    for i := 0; i < paddingLines; i++ {
        s += "\n"
    }

    // Search box (if active)
    if m.searchMode {
        s += "\n"
        s += searchLabel + "\n"
        s += searchBox + "\n"
    }

    // Footer
    s += "\n"
    s += footer

    return s
}
```

### Key Constants

```go
// From renderNamespaceList viewport calculation (line 957-961)
headerLines := 2
footerLines := 2
scrollIndicatorLines := 1
fixedSearchBoxLines := 3  // Always reserved

// From padding calculation (line 1059)
searchAndFooterLines := 2 + 3  // ALWAYS FIXED
```

## Steps to Reproduce

1. Run kubertino TUI
2. Select a context with namespaces
3. Observe the namespace panel height (left panel, full terminal height)
4. Press `/` to activate search mode
5. **BUG**: Panel height changes (grows)
6. Press `ESC` to deactivate search mode
7. **BUG**: Panel height changes back (shrinks)

## Test Environment

- **OS**: macOS (Darwin 24.1.0)
- **Terminal**: Various sizes tested
- **Go Version**: (from project)
- **Kubertino Version**: Story 7.2 implementation

## Debugging Suggestions

### Debug Strategy 1: Add Explicit Height Logging
Add debug logging to see actual vs expected heights:

```go
// In renderNamespacePanel
slog.Debug("panel sizing",
    "allocated_height", height,
    "content_height", contentHeight,
    "search_mode", m.searchMode,
    "content_lines", strings.Count(content, "\n"))
```

### Debug Strategy 2: Test Without Lip Gloss Height()
Try removing the `.Height()` directive and manually padding content to exact line count:

```go
// Calculate exact lines needed
totalLines := height - 4

// Count actual content lines
contentLines := strings.Count(content, "\n") + 1

// Add extra newlines to fill
if contentLines < totalLines {
    content += strings.Repeat("\n", totalLines - contentLines)
}

return borderStyle.
    Width(contentWidth).
    // Remove Height() - let content determine height
    Render(content)
```

### Debug Strategy 3: Visual Markers
Add visual markers to see where the panel edges actually are:

```go
// At start of content
s := "╔═══ TOP ═══╗\n"

// ... normal content ...

// At end of content (before return)
s += "╚═══ BOTTOM ═══╝"
```

### Debug Strategy 4: Compare Line Counts
Print exact line counts in both modes:

```go
// In renderNamespaceList before return
lineCount := strings.Count(s, "\n") + 1
slog.Debug("content generated",
    "search_mode", m.searchMode,
    "line_count", lineCount,
    "effective_height", effectiveHeight,
    "lines_used", linesUsed,
    "padding_lines", paddingLines)
```

## Proposed Solutions

### Solution 1: Force Fixed Line Count
Instead of relying on Lip Gloss `.Height()`, force the content string to have EXACTLY the right number of lines:

```go
func (m AppModel) renderNamespacePanel(width, height int) string {
    contentHeight := height - 4
    content := m.renderNamespaceList(contentHeight)

    // FORCE content to have exactly contentHeight lines
    currentLines := strings.Count(content, "\n") + 1
    if currentLines < contentHeight {
        content += strings.Repeat("\n", contentHeight - currentLines)
    } else if currentLines > contentHeight {
        // Truncate if too long (shouldn't happen)
        lines := strings.Split(content, "\n")
        content = strings.Join(lines[:contentHeight], "\n")
    }

    return borderStyle.Width(contentWidth).Render(content)
}
```

### Solution 2: Use Lip Gloss MaxHeight Instead
Try using `MaxHeight()` and `MinHeight()` together:

```go
return borderStyle.
    Width(contentWidth).
    MinHeight(height - 4).
    MaxHeight(height - 4).
    Render(content)
```

### Solution 3: Separate Search Box Rendering
Move search box rendering OUTSIDE of the content panel:

```go
// In renderSplitLayout
namespaceContent := m.renderNamespaceList(contentHeight)
namespacePanel := m.renderNamespacePanel(leftWidth, availableHeight, namespaceContent)

// Render search box separately as overlay if active
if m.searchMode {
    searchOverlay := m.renderSearchBox()
    // Position search box at bottom of namespace panel
    // Use lipgloss.Place or absolute positioning
}
```

### Solution 4: Pre-calculate ALL Lines
Calculate the EXACT content that should be rendered in both modes BEFORE any rendering:

```go
// Calculate total lines available
totalAvailableLines := effectiveHeight

// Build content array (not string)
var lines []string

// Add header (2 lines)
lines = append(lines, headerLine1, headerLine2)

// Add namespaces (variable count)
for i := start; i < end; i++ {
    lines = append(lines, renderNamespace(i))
}

// Add scroll indicator if needed (1 line)
if needsScroll {
    lines = append(lines, scrollIndicator)
}

// Calculate how many EMPTY lines to add
emptyLinesNeeded := totalAvailableLines - len(lines) - 5  // 5 = search(3) + footer(2)

// Add empty lines
for i := 0; i < emptyLinesNeeded; i++ {
    lines = append(lines, "")
}

// Add search box ALWAYS (3 lines)
if m.searchMode {
    lines = append(lines, "", searchLabel, searchBox)
} else {
    lines = append(lines, "", "", "")  // Empty lines to maintain height
}

// Add footer ALWAYS (2 lines)
lines = append(lines, "", footer)

// Join to string
s := strings.Join(lines, "\n")
```

## Files Involved

- `internal/tui/app.go` (lines 1202-1233: renderNamespacePanel)
- `internal/tui/app.go` (lines 956-1116: renderNamespaceList)
- `internal/tui/styles/styles.go` (lines 111-122: panel border styles)

## Related Documentation

- Story: `docs/stories/7.2.namespace-search-ui-improvement.md`
- QA Gate: `docs/qa/gates/7.2-namespace-search-ui-improvement.yml`
- Tests: `internal/tui/search_test.go`

## Acceptance Criteria for Fix

✅ Panel height must remain **pixel-perfect identical** in both modes
✅ Pressing `/` should NOT cause any visual change in panel size
✅ Pressing `ESC` should NOT cause any visual change in panel size
✅ Search box should appear at bottom without shifting anything else
✅ All existing tests must continue to pass
✅ Manual visual testing on terminals: 80x24, 120x30, 160x40

## Priority

**HIGH** - This blocks Story 7.2 from being marked "Done"

## Estimated Complexity

**MEDIUM-HIGH** - May require refactoring the rendering approach or understanding Lip Gloss internals better

## Assignment

**Dev Team** - Requires investigation and potentially architectural changes to rendering logic

## Additional Notes

- All 4 QA iterations have tried to fix this from different angles
- The problem is subtle and may be related to terminal rendering or Lip Gloss behavior
- Consider reaching out to Lip Gloss maintainers if the issue is with the library itself
- May need to switch approach from "fix height calculation" to "fix content generation"

## User Quote

> "Все еще высота неправильная - сначала маленькая а при поиске слишком большая"
>
> (Translation: "Height still wrong - first small, then too large during search")

This user feedback after 4 fix attempts indicates a fundamental issue with our approach that needs developer investigation.
